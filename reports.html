<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - StockMaster</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; line-height: 1.6; overflow-x: hidden; }
        .container { display: flex; min-height: 100vh; width: 100%; max-width: 100%; margin: 0 auto; }
        .sidebar {
            background: var(--primary);
            color: #fff;
            padding: 20px 0;
            width: 250px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        .sidebar.mobile-hidden { transform: translateX(-250px); }
        .sidebar.mobile-visible { transform: translateX(0); }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,.1); margin-bottom: 20px; }
        .logo h1 { font-size: 24px; font-weight: 600; }
        .logo span { color: var(--secondary); }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; cursor: pointer; transition: all .3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,.1); border-left: 4px solid var(--secondary); }
        .menu-item i { margin-right: 15px; font-size: 18px; }
        .main-content { flex: 1; padding: 20px; margin-left: 250px; max-width: 100%; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        .search-bar { display: flex; align-items: center; background: #f5f7fa; border-radius: 4px; padding: 8px 15px; width: 300px; }
        .search-bar input { border: none; background: transparent; width: 100%; padding: 5px; outline: none; }
        .user-profile { display: flex; align-items: center; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); display: flex; flex-direction: column; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 16px; color: var(--gray); font-weight: 500; }
        .card-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .card-value { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .filters { background: #fff; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: var(--gray); }
        .filter-group select, .filter-group input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .reports-table { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: var(--gray); background: #f9f9f9; }
        .tag { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; display: inline-block; }
        .tag.sales { background: rgba(52,152,219,.15); color: var(--secondary); }
        .tag.inventory { background: rgba(46,204,113,.15); color: var(--success); }
        .tag.supply { background: rgba(243,156,18,.15); color: var(--warning); }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all .3s; }
        .btn-primary { background: var(--secondary); color: #fff; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-success:hover { background: #27ae60; }
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-warning:hover { background: #e67e22; }
        #mobile-menu-btn { display: none; border: none; background: transparent; font-size: 22px; margin-right: 10px; cursor: pointer; }
        @media (max-width: 992px) {
            .container { flex-direction: column; }
            .sidebar { transform: translateX(-250px); }
            .sidebar.mobile-visible { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .search-bar { width: 100%; margin-bottom: 15px; }
            .action-buttons { width: 100%; justify-content: space-between; }
            .btn { flex: 1; justify-content: center; }
            #mobile-menu-btn { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <select id="global-warehouse" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid rgba(255,255,255,.3); background:#1f2d3a; color:#fff; margin-bottom:8px;"></select>
                <h1>Stock<span>Master</span></h1>
            </div>
            <div class="menu-item" data-href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></div>
            <div class="menu-item" data-href="products.html"><i class="fas fa-boxes"></i><span>Products</span></div>
            <div class="menu-item" data-href="inventory.html"><i class="fas fa-warehouse"></i><span>Inventory</span></div>
            <div class="menu-item" data-href="orders.html"><i class="fas fa-file-invoice-dollar"></i><span>Orders</span></div>
            <div class="menu-item" data-href="transfers.html"><i class="fas fa-exchange-alt"></i><span>Transfers</span></div>
            <div class="menu-item active" data-href="reports.html"><i class="fas fa-chart-bar"></i><span>Reports</span></div>
            <div class="menu-item" data-href="suppliers.html"><i class="fas fa-users"></i><span>Suppliers</span></div>
            <div class="menu-item" data-href="settings.html"><i class="fas fa-cog"></i><span>Settings</span></div>
            <div class="menu-item" data-href="help.html"><i class="fas fa-question-circle"></i><span>Help & Support</span></div>
        </div>
        <div class="main-content">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%; gap:8px;">
                    <button id="mobile-menu-btn">☰</button>
                    <div class="search-bar" style="flex:1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Search reports...">
                    </div>
                </div>
                <div class="user-profile" id="user-profile">
                    <div style="margin-right:10px;">
                        <div id="user-name">User</div>
                        <small id="user-role">Authenticated</small>
                    </div>
                    <button id="btn-logout" class="btn" style="background:#fff; color:#e74c3c; border:1px solid #e74c3c; padding:8px 10px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
            <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 class="page-title">Reports</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-generate"><i class="fas fa-chart-line"></i> Generate</button>
                    <button class="btn btn-success" id="btn-export"><i class="fas fa-file-export"></i> Export</button>
                </div>
            </div>

            <div class="dashboard-cards">
                <div class="card" id="sales-card">
                    <div class="card-header">
                        <div class="card-title">Sales (30d)</div>
                        <div class="card-icon" style="background: var(--secondary);"><i class="fas fa-receipt"></i></div>
                    </div>
                    <div class="card-value">$0</div>
                    <div class="positive"><i class="fas fa-arrow-up"></i> 0%</div>
                </div>
                <div class="card" id="top-category-card">
                    <div class="card-header">
                        <div class="card-title">Top Category</div>
                        <div class="card-icon" style="background: var(--success);"><i class="fas fa-tags"></i></div>
                    </div>
                    <div class="card-value">None</div>
                    <div class="positive">0% of sales</div>
                </div>
                <div class="card" id="low-stock-card">
                    <div class="card-header">
                        <div class="card-title">Low Stock Items</div>
                        <div class="card-icon" style="background: var(--warning);"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <div class="card-value">0</div>
                    <div class="negative"><i class="fas fa-arrow-up"></i> 0%</div>
                </div>
                <div class="card" id="cancelled-orders-card">
                    <div class="card-header">
                        <div class="card-title">Cancelled Orders</div>
                        <div class="card-icon" style="background: var(--danger);"><i class="fas fa-ban"></i></div>
                    </div>
                    <div class="card-value">0</div>
                    <div class="positive"><i class="fas fa-arrow-down"></i> 0%</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType">
                        <option value="">All</option>
                        <option value="sales">Sales</option>
                        <option value="inventory">Inventory</option>
                        <option value="supply">Supply & Reorders</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFrom">From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">To</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label for="groupBy">Group By</label>
                    <select id="groupBy">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="warehouse">Warehouse</label>
                    <select id="warehouse">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" placeholder="SKU, product, supplier...">
                </div>
            </div>

            <div class="reports-table">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Date Range</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reports-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:900;"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, orderBy, onSnapshot, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        (function(){
            const setHeader = (displayName, email) => {
                const name = displayName || email || 'User';
                const nameEl = document.getElementById('user-name');
                if (nameEl) nameEl.textContent = name;
            };

            const init = async () => {
                try {
                    const app = initializeApp({ 
                        apiKey: "AIzaSyAqBR_6p-5752sVeu_aMT2sNU2I_nUmaOQ", 
                        authDomain: "inventory-3b638.firebaseapp.com", 
                        projectId: "inventory-3b638", 
                        storageBucket: "inventory-3b638.firebasestorage.app", 
                        messagingSenderId: "65748912542", 
                        appId: "1:65748912542:web:8d40510d194bb3e1d6ae8f", 
                        measurementId: "G-6ECQLDLS71" 
                    });
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            window.location.href = 'login.html';
                            return;
                        }
                        setHeader(user.displayName, user.email);
                        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.href = 'login.html');
                        await syncUserAccess(db, user);
                        const currency = await loadCompanyCurrency(db, user);
                        setupReports(db, user, currency);
                    });
                } catch (e) {
                    console.error('Firebase initialization failed:', e);
                    alert('Failed to initialize application. Please try again later.');
                    window.location.href = 'login.html';
                }
            };

            async function syncUserAccess(db, user) {
                try {
                    const meRef = doc(db, 'users', user.uid);
                    const meSnap = await getDoc(meRef);
                    if (!meSnap.exists()) {
                        await setDoc(meRef, { 
                            role: 'staff', 
                            warehouses: [],
                            name: user.displayName || user.email || 'User',
                            email: user.email,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error('syncUserAccess error:', e);
                }
            }

            async function loadCompanyCurrency(db, user) {
                try {
                    const ref = doc(db, `users/${user.uid}/settings`, 'profile');
                    const snap = await getDoc(ref);
                    return snap.exists() ? (snap.data().company?.currency || 'USD') : 'USD';
                } catch { return 'USD'; }
            }

            function currencySymbol(code) {
                const map = { USD: '$', EUR: '€', GBP: '£', INR: '₹', TZS: 'TSh', KES: 'KSh', UGX: 'USh' };
                return map[code] || code + ' ';
            }

            function formatDate(timestamp) {
                if (!timestamp) return '';
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            }

            async function setupReports(db, user, currencyCode) {
                const reportType = document.getElementById('reportType');
                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');
                const groupBy = document.getElementById('groupBy');
                const searchInput = document.getElementById('search');
                const searchTableInput = document.getElementById('search-input');
                const warehouseFilter = document.getElementById('warehouse');
                const reportsBody = document.getElementById('reports-body');
                let allowedWarehouses = null;
                let warehouses = [];
                let unsubscribeReports = null;

                // Set default date range (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
                dateTo.value = today.toISOString().split('T')[0];

                // Load user access
                async function loadUserContext() {
                    try {
                        const meRef = doc(db, 'users', user.uid);
                        const meSnap = await getDoc(meRef);
                        if (meSnap.exists()) {
                            const u = meSnap.data();
                            const role = u.role || 'staff';
                            const arr = Array.isArray(u.warehouses) ? u.warehouses.filter(Boolean) : [];
                            allowedWarehouses = (role === 'admin') ? null : arr;
                        } else {
                            allowedWarehouses = null;
                        }
                        await loadWarehouses();
                        await updateDashboardCards();
                        await renderReports();
                    } catch (e) { 
                        console.error('Failed to load user context', e); 
                    }
                }

                // Load warehouses
                async function loadWarehouses() {
                    try {
                        let q = query(collection(db, 'warehouses'), orderBy('name'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            q = query(q, where('name', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        const snap = await getDocs(q);
                        warehouses = snap.docs.map(d => d.data().name).filter(Boolean);
                        
                        // Update global warehouse dropdown
                        const globalWarehouseSelect = document.getElementById('global-warehouse');
                        if (globalWarehouseSelect) {
                            const saved = localStorage.getItem('selectedWarehouse') || '';
                            globalWarehouseSelect.innerHTML = '<option value="">All Warehouses</option>';
                            warehouses.forEach(w => {
                                const opt = document.createElement('option');
                                opt.value = w;
                                opt.textContent = w;
                                globalWarehouseSelect.appendChild(opt);
                            });
                            globalWarehouseSelect.value = warehouses.includes(saved) ? saved : '';
                        }
                        
                        // Update warehouse filter
                        if (warehouseFilter) {
                            warehouseFilter.innerHTML = '<option value="">All</option>';
                            warehouses.forEach(w => {
                                const opt = document.createElement('option');
                                opt.value = w;
                                opt.textContent = w;
                                warehouseFilter.appendChild(opt);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading warehouses:', error);
                    }
                }

                // Update dashboard cards
                async function updateDashboardCards() {
                    try {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        
                        // Sales (30d)
                        let ordersQuery = query(
                            collection(db, 'orders'), 
                            where('createdAt', '>=', thirtyDaysAgo)
                        );
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            ordersQuery = query(ordersQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        
                        const ordersSnap = await getDocs(ordersQuery);
                        let totalSales = 0;
                        let categorySales = {};
                        
                        ordersSnap.forEach(doc => {
                            const order = doc.data();
                            if (order.status === 'paid' || order.status === 'completed') {
                                totalSales += Number(order.total || 0);
                                if (order.items && Array.isArray(order.items)) {
                                    order.items.forEach(item => {
                                        const category = item.category || 'Unknown';
                                        categorySales[category] = (categorySales[category] || 0) + (item.qty * (item.unitPrice || 0));
                                    });
                                }
                            }
                        });
                        
                        document.querySelector('#sales-card .card-value').textContent = `${currencySymbol(currencyCode)}${totalSales.toFixed(2)}`;
                        document.querySelector('#sales-card .positive').innerHTML = totalSales > 0 ? `<i class="fas fa-arrow-up"></i> Active` : 'No sales';
                        
                        // Top Category
                        const topCategory = Object.entries(categorySales).sort((a, b) => b[1] - a[1])[0];
                        document.querySelector('#top-category-card .card-value').textContent = topCategory ? topCategory[0].substring(0, 10) + (topCategory[0].length > 10 ? '...' : '') : 'None';
                        if (topCategory && totalSales > 0) {
                            const percentage = ((topCategory[1] / totalSales) * 100).toFixed(1);
                            document.querySelector('#top-category-card .positive').textContent = `${percentage}% of sales`;
                        } else {
                            document.querySelector('#top-category-card .positive').textContent = '0% of sales';
                        }
                        
                        // Low Stock Items
                        let productsQuery = query(collection(db, 'products'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            productsQuery = query(productsQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        
                        const productsSnap = await getDocs(productsQuery);
                        let lowStockCount = 0;
                        productsSnap.forEach(doc => {
                            const product = doc.data();
                            if ((product.stock || 0) < 20) lowStockCount++;
                        });
                        
                        document.querySelector('#low-stock-card .card-value').textContent = lowStockCount;
                        document.querySelector('#low-stock-card .negative').innerHTML = lowStockCount > 0 ? `<i class="fas fa-arrow-up"></i> ${lowStockCount} items` : 'All good';
                        
                        // Cancelled Orders
                        let cancelledOrdersQuery = query(
                            collection(db, 'orders'), 
                            where('status', '==', 'cancelled'), 
                            where('createdAt', '>=', thirtyDaysAgo)
                        );
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            cancelledOrdersQuery = query(cancelledOrdersQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        
                        const cancelledSnap = await getDocs(cancelledOrdersQuery);
                        const cancelledCount = cancelledSnap.size;
                        document.querySelector('#cancelled-orders-card .card-value').textContent = cancelledCount;
                        document.querySelector('#cancelled-orders-card .positive').innerHTML = cancelledCount > 0 ? `<i class="fas fa-arrow-up"></i> ${cancelledCount} orders` : 'No cancellations';
                        
                    } catch (error) {
                        console.error('Error updating dashboard cards:', error);
                    }
                }

                // Render reports
                async function renderReports() {
                    try {
                        if (unsubscribeReports) unsubscribeReports();
                        
                        let reportsQuery = query(collection(db, 'reports'), orderBy('createdAt', 'desc'));
                        
                        unsubscribeReports = onSnapshot(reportsQuery, (snap) => {
                            reportsBody.innerHTML = '';
                            
                            if (snap.empty) {
                                reportsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#95a5a6; padding:20px;">No reports found. Generate a report to get started.</td></tr>';
                                return;
                            }
                            
                            snap.forEach(doc => {
                                const report = doc.data();
                                const tr = document.createElement('tr');
                                tr.dataset.id = doc.id;
                                
                                // Determine tag class
                                let tagClass = 'sales';
                                if (report.type === 'inventory') tagClass = 'inventory';
                                if (report.type === 'supply') tagClass = 'supply';
                                
                                tr.innerHTML = `
                                    <td>${report.title || 'Untitled Report'}</td>
                                    <td><span class="tag ${tagClass}">${(report.type || 'sales').charAt(0).toUpperCase() + (report.type || 'sales').slice(1)}</span></td>
                                    <td>${formatDate(report.dateFrom)} → ${formatDate(report.dateTo)}</td>
                                    <td>${formatDate(report.createdAt)}</td>
                                    <td>
                                        <button class="btn btn-primary btn-view"><i class="fas fa-eye"></i> View</button>
                                        <button class="btn btn-success btn-download"><i class="fas fa-download"></i> Download</button>
                                    </td>
                                `;
                                
                                tr.querySelector('.btn-view').onclick = () => viewReport(doc.id, report);
                                tr.querySelector('.btn-download').onclick = () => downloadReport(doc.id, report);
                                reportsBody.appendChild(tr);
                            });
                            
                            applyFilters();
                            
                        }, (error) => {
                            console.error('Error loading reports:', error);
                            reportsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#e74c3c; padding:20px;">Failed to load reports. Please check your connection and try again.</td></tr>';
                        });
                        
                    } catch (error) {
                        console.error('Error in renderReports:', error);
                        reportsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#e74c3c; padding:20px;">Error loading reports.</td></tr>';
                    }
                }

                // View report
                function viewReport(id, report) {
                    const reportData = report.data || {};
                    let details = `Report: ${report.title || 'Untitled'}\n`;
                    details += `Type: ${report.type || 'Unknown'}\n`;
                    details += `Date Range: ${formatDate(report.dateFrom)} → ${formatDate(report.dateTo)}\n`;
                    details += `Warehouse: ${report.warehouse || 'All'}\n`;
                    details += `Created: ${formatDate(report.createdAt)}\n\n`;
                    details += `Data:\n${JSON.stringify(reportData, null, 2)}`;
                    
                    alert(details);
                }

                // Download report
                function downloadReport(id, report) {
                    try {
                        const reportData = report.data || {};
                        let csvContent = 'Report Data\n';
                        
                        // Add metadata
                        csvContent += `Title,${report.title || 'Untitled'}\n`;
                        csvContent += `Type,${report.type || 'Unknown'}\n`;
                        csvContent += `Date From,${formatDate(report.dateFrom)}\n`;
                        csvContent += `Date To,${formatDate(report.dateTo)}\n`;
                        csvContent += `Warehouse,${report.warehouse || 'All'}\n`;
                        csvContent += `Created,${formatDate(report.createdAt)}\n\n`;
                        
                        // Add data
                        csvContent += 'Metric,Value\n';
                        Object.entries(reportData).forEach(([key, value]) => {
                            csvContent += `${key},${value}\n`;
                        });
                        
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const fileName = `report_${(report.title || 'untitled').replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${formatDate(report.createdAt)}.csv`;
                        a.download = fileName;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert(`Report "${report.title || 'Untitled'}" downloaded successfully.`);
                    } catch (error) {
                        console.error('Error downloading report:', error);
                        alert('Failed to download report. Please try again.');
                    }
                }

                // Generate report
                document.getElementById('btn-generate').onclick = async () => {
                    try {
                        const type = reportType.value || 'sales';
                        const from = dateFrom.value ? new Date(dateFrom.value) : new Date();
                        const to = dateTo.value ? new Date(dateTo.value) : new Date();
                        const warehouse = warehouseFilter.value;
                        
                        if (from > to) {
                            alert('Start date cannot be after end date.');
                            return;
                        }
                        
                        // Calculate data based on report type
                        let reportData = {};
                        let title = '';
                        
                        if (type === 'sales') {
                            let ordersQuery = query(
                                collection(db, 'orders'),
                                where('date', '>=', from.toISOString().split('T')[0]),
                                where('date', '<=', to.toISOString().split('T')[0])
                            );
                            
                            if (warehouse) {
                                ordersQuery = query(ordersQuery, where('warehouse', '==', warehouse));
                            } else if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                ordersQuery = query(ordersQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            
                            const snap = await getDocs(ordersQuery);
                            let totalSales = 0;
                            let orderCount = 0;
                            let paidOrders = 0;
                            
                            snap.forEach(doc => {
                                const order = doc.data();
                                orderCount++;
                                if (order.status === 'paid' || order.status === 'completed') {
                                    paidOrders++;
                                    totalSales += Number(order.total || 0);
                                }
                            });
                            
                            reportData = {
                                totalSales: totalSales,
                                orderCount: orderCount,
                                paidOrders: paidOrders,
                                conversionRate: orderCount > 0 ? ((paidOrders / orderCount) * 100).toFixed(2) + '%' : '0%'
                            };
                            
                            title = `Sales Report ${formatDate(from)} to ${formatDate(to)}`;
                            if (warehouse) title += ` - ${warehouse}`;
                            
                        } else if (type === 'inventory') {
                            let productsQuery = query(collection(db, 'products'));
                            
                            if (warehouse) {
                                productsQuery = query(productsQuery, where('warehouse', '==', warehouse));
                            } else if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                productsQuery = query(productsQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            
                            const snap = await getDocs(productsQuery);
                            let totalProducts = 0;
                            let lowStockCount = 0;
                            let outOfStockCount = 0;
                            let totalValue = 0;
                            
                            snap.forEach(doc => {
                                const product = doc.data();
                                totalProducts++;
                                if ((product.stock || 0) < 20) lowStockCount++;
                                if ((product.stock || 0) === 0) outOfStockCount++;
                                totalValue += (product.stock || 0) * (product.price || 0);
                            });
                            
                            reportData = {
                                totalProducts: totalProducts,
                                lowStockItems: lowStockCount,
                                outOfStockItems: outOfStockCount,
                                inventoryValue: totalValue.toFixed(2)
                            };
                            
                            title = `Inventory Report ${formatDate(from)} to ${formatDate(to)}`;
                            if (warehouse) title += ` - ${warehouse}`;
                            
                        } else if (type === 'supply') {
                            let productsQuery = query(collection(db, 'products'));
                            
                            if (warehouse) {
                                productsQuery = query(productsQuery, where('warehouse', '==', warehouse));
                            } else if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                productsQuery = query(productsQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            
                            const snap = await getDocs(productsQuery);
                            let reorderNeeded = 0;
                            let lowStockItems = 0;
                            let criticalItems = 0;
                            
                            snap.forEach(doc => {
                                const product = doc.data();
                                const stock = product.stock || 0;
                                if (stock < 5) criticalItems++;
                                if (stock < 20) lowStockItems++;
                                if (stock < 10) reorderNeeded++;
                            });
                            
                            reportData = {
                                reorderNeeded: reorderNeeded,
                                lowStockItems: lowStockItems,
                                criticalItems: criticalItems
                            };
                            
                            title = `Supply Report ${formatDate(from)} to ${formatDate(to)}`;
                            if (warehouse) title += ` - ${warehouse}`;
                        }
                        
                        // Save report to Firestore
                        const reportRef = await addDoc(collection(db, 'reports'), {
                            title: title,
                            type: type,
                            dateFrom: from,
                            dateTo: to,
                            warehouse: warehouse || '',
                            data: reportData,
                            createdAt: serverTimestamp(),
                            createdBy: user.uid
                        });
                        
                        alert(`Report "${title}" generated successfully!`);
                        
                    } catch (error) {
                        console.error('Error generating report:', error);
                        alert(`Failed to generate report: ${error.message}`);
                    }
                };

                // Export all reports
                document.getElementById('btn-export').onclick = async () => {
                    try {
                        let reportsQuery = query(collection(db, 'reports'), orderBy('createdAt', 'desc'));
                        const snap = await getDocs(reportsQuery);
                        
                        if (snap.empty) {
                            alert('No reports to export.');
                            return;
                        }
                        
                        let csvContent = 'Title,Type,Date From,Date To,Warehouse,Created\n';
                        
                        snap.forEach(doc => {
                            const report = doc.data();
                            csvContent += `"${report.title || ''}","${report.type || ''}","${formatDate(report.dateFrom)}","${formatDate(report.dateTo)}","${report.warehouse || ''}","${formatDate(report.createdAt)}"\n`;
                        });
                        
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert(`Exported ${snap.size} reports successfully.`);
                    } catch (error) {
                        console.error('Error exporting reports:', error);
                        alert('Failed to export reports. Please try again.');
                    }
                };

                // Apply filters
                function applyFilters() {
                    const typeVal = reportType.value;
                    const fromVal = dateFrom.value ? new Date(dateFrom.value) : null;
                    const toVal = dateTo.value ? new Date(dateTo.value) : null;
                    const warehouseVal = warehouseFilter.value;
                    const queryText = (searchInput.value || searchTableInput.value || '').toLowerCase();
                    
                    const rows = reportsBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        if (row.cells.length < 5) return;
                        
                        const title = row.cells[0].textContent.toLowerCase();
                        const typeSpan = row.querySelector('.tag');
                        const rowType = typeSpan ? typeSpan.textContent.toLowerCase() : '';
                        const dateRange = row.cells[2].textContent.split('→').map(s => s.trim());
                        const start = dateRange[0] ? new Date(dateRange[0]) : null;
                        const end = dateRange[1] ? new Date(dateRange[1]) : null;
                        
                        let visible = true;
                        
                        // Filter by type
                        if (typeVal && !rowType.includes(typeVal.toLowerCase())) {
                            visible = false;
                        }
                        
                        // Filter by date range
                        if (fromVal && end && end < fromVal) {
                            visible = false;
                        }
                        if (toVal && start && start > toVal) {
                            visible = false;
                        }
                        
                        // Filter by search
                        if (queryText && !title.includes(queryText)) {
                            visible = false;
                        }
                        
                        row.style.display = visible ? '' : 'none';
                    });
                }

                // Bind filter events
                [reportType, dateFrom, dateTo, groupBy, warehouseFilter, searchInput, searchTableInput].forEach(el => {
                    if (el) {
                        el.addEventListener('change', applyFilters);
                        el.addEventListener('keyup', applyFilters);
                    }
                });

                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const href = item.dataset.href;
                        if (href) window.location.href = href;
                    });
                });

                // Mobile sidebar toggle
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        sidebar.classList.toggle('mobile-hidden');
                        sidebar.classList.toggle('mobile-visible');
                        overlay.style.display = sidebar.classList.contains('mobile-visible') ? 'block' : 'none';
                    };
                }
                if (overlay) {
                    overlay.onclick = () => {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                        overlay.style.display = 'none';
                    };
                }

                // Initialize global warehouse dropdown
                const globalWarehouseSelect = document.getElementById('global-warehouse');
                if (globalWarehouseSelect) {
                    globalWarehouseSelect.addEventListener('change', () => {
                        localStorage.setItem('selectedWarehouse', globalWarehouseSelect.value);
                        const pageFilter = document.getElementById('warehouse');
                        if (pageFilter) pageFilter.value = globalWarehouseSelect.value;
                        updateDashboardCards();
                        renderReports();
                    });
                }

                // Initialize
                await loadUserContext();
            }

            init();
        })();
    </script>
</body>
</html>
