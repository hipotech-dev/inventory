<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - StockMaster</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; line-height: 1.6; overflow-x: hidden; }
        .container { display: flex; min-height: 100vh; width: 100%; max-width: 100%; margin: 0 auto; }
        .sidebar {
            background: var(--primary);
            color: #fff;
            padding: 20px 0;
            width: 250px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        .sidebar.mobile-hidden { transform: translateX(-250px); }
        .sidebar.mobile-visible { transform: translateX(0); }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,.1); margin-bottom: 20px; }
        .logo h1 { font-size: 24px; font-weight: 600; }
        .logo span { color: var(--secondary); }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; cursor: pointer; transition: all .3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,.1); border-left: 4px solid var(--secondary); }
        .menu-item i { margin-right: 15px; font-size: 18px; }
        .main-content { flex: 1; padding: 20px; margin-left: 250px; max-width: 100%; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        .search-bar { display: flex; align-items: center; background: #f5f7fa; border-radius: 4px; padding: 8px 15px; width: 300px; }
        .search-bar input { border: none; background: transparent; width: 100%; padding: 5px; outline: none; }
        .user-profile { display: flex; align-items: center; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); display: flex; flex-direction: column; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 16px; color: var(--gray); font-weight: 500; }
        .card-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .card-value { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .filters { background: #fff; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: var(--gray); }
        .filter-group select, .filter-group input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .reports-table { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: var(--gray); background: #f9f9f9; }
        .tag { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; display: inline-block; }
        .tag.sales { background: rgba(52,152,219,.15); color: var(--secondary); }
        .tag.inventory { background: rgba(46,204,113,.15); color: var(--success); }
        .tag.supply { background: rgba(243,156,18,.15); color: var(--warning); }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all .3s; }
        .btn-primary { background: var(--secondary); color: #fff; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-success:hover { background: #27ae60; }
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-warning:hover { background: #e67e22; }
        #mobile-menu-btn { display: none; border: none; background: transparent; font-size: 22px; margin-right: 10px; cursor: pointer; }
        @media (max-width: 992px) {
            .container { flex-direction: column; }
            .sidebar { transform: translateX(-250px); }
            .sidebar.mobile-visible { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .search-bar { width: 100%; margin-bottom: 15px; }
            .action-buttons { width: 100%; justify-content: space-between; }
            .btn { flex: 1; justify-content: center; }
            #mobile-menu-btn { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <select id="global-warehouse" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid rgba(255,255,255,.3); background:#1f2d3a; color:#fff; margin-bottom:8px;"></select>
                <h1>Stock<span>Master</span></h1>
            </div>
            <div class="menu-item" data-href="index.html"><i class="fas fa-home"></i><span>Dashboard</span></div>
            <div class="menu-item" data-href="products.html"><i class="fas fa-boxes"></i><span>Products</span></div>
            <div class="menu-item" data-href="inventory.html"><i class="fas fa-warehouse"></i><span>Inventory</span></div>
            <div class="menu-item" data-href="orders.html"><i class="fas fa-file-invoice-dollar"></i><span>Orders</span></div>
            <div class="menu-item" data-href="transfers.html"><i class="fas fa-exchange-alt"></i><span>Transfers</span></div>
            <div class="menu-item active" data-href="reports.html"><i class="fas fa-chart-bar"></i><span>Reports</span></div>
            <div class="menu-item" data-href="suppliers.html"><i class="fas fa-users"></i><span>Suppliers</span></div>
            <div class="menu-item" data-href="settings.html"><i class="fas fa-cog"></i><span>Settings</span></div>
            <div class="menu-item" data-href="help.html"><i class="fas fa-question-circle"></i><span>Help & Support</span></div>
        </div>
        <div class="main-content">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%; gap:8px;">
                    <button id="mobile-menu-btn">☰</button>
                    <div class="search-bar" style="flex:1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search" placeholder="Search reports...">
                    </div>
                </div>
                <div class="user-profile" id="user-profile">
                    <div style="margin-right:10px;">
                        <div id="user-name">User</div>
                        <small id="user-role">Authenticated</small>
                    </div>
                    <button id="btn-logout" class="btn" style="background:#fff; color:#e74c3c; border:1px solid #e74c3c; padding:8px 10px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
            <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 class="page-title">Reports</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-generate"><i class="fas fa-chart-line"></i> Generate</button>
                    <button class="btn btn-success" id="btn-export"><i class="fas fa-file-export"></i> Export</button>
                </div>
            </div>

            <div class="dashboard-cards">
                <div class="card" id="sales-card">
                    <div class="card-header">
                        <div class="card-title">Sales (30d)</div>
                        <div class="card-icon" style="background: var(--secondary);"><i class="fas fa-receipt"></i></div>
                    </div>
                    <div class="card-value">$0</div>
                    <div class="positive"><i class="fas fa-arrow-up"></i> 0%</div>
                </div>
                <div class="card" id="top-category-card">
                    <div class="card-header">
                        <div class="card-title">Top Category</div>
                        <div class="card-icon" style="background: var(--success);"><i class="fas fa-tags"></i></div>
                    </div>
                    <div class="card-value">None</div>
                    <div class="positive">0% of sales</div>
                </div>
                <div class="card" id="low-stock-card">
                    <div class="card-header">
                        <div class="card-title">Low Stock Items</div>
                        <div class="card-icon" style="background: var(--warning);"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <div class="card-value">0</div>
                    <div class="negative"><i class="fas fa-arrow-up"></i> 0%</div>
                </div>
                <div class="card" id="cancelled-orders-card">
                    <div class="card-header">
                        <div class="card-title">Cancelled Orders</div>
                        <div class="card-icon" style="background: var(--danger);"><i class="fas fa-ban"></i></div>
                    </div>
                    <div class="card-value">0</div>
                    <div class="positive"><i class="fas fa-arrow-down"></i> 0%</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType">
                        <option value="">All</option>
                        <option value="sales">Sales</option>
                        <option value="inventory">Inventory</option>
                        <option value="supply">Supply & Reorders</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFrom">From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">To</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label for="groupBy">Group By</label>
                    <select id="groupBy">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="warehouse">Warehouse</label>
                    <select id="warehouse">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" placeholder="SKU, product, supplier...">
                </div>
            </div>

            <div class="reports-table">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Date Range</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reports-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:900;"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, query, where, orderBy, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        (function(){
            const setHeader = (displayName, email) => {
                const name = displayName || email || 'User';
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
                const nameEl = document.getElementById('user-name');
                const avatarEl = document.getElementById('user-avatar');
                if (nameEl) nameEl.textContent = name;
                if (avatarEl) avatarEl.src = avatar;
            };

            const init = async () => {
                try {
                    const app = initializeApp({ 
                        apiKey: "AIzaSyAqBR_6p-5752sVeu_aMT2sNU2I_nUmaOQ", 
                        authDomain: "inventory-3b638.firebaseapp.com", 
                        projectId: "inventory-3b638", 
                        storageBucket: "inventory-3b638.firebasestorage.app", 
                        messagingSenderId: "65748912542", 
                        appId: "1:65748912542:web:8d40510d194bb3e1d6ae8f", 
                        measurementId: "G-6ECQLDLS71" 
                    });
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            window.location.href = 'login.html';
                            return;
                        }
                        setHeader(user.displayName, user.email);
                        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.href = 'login.html');
                        await syncUserAccess(db, user);
                        const currency = await loadCompanyCurrency(db, user);
                        setupReports(db, user, currency);
                    });
                } catch (e) {
                    console.error('Firebase initialization failed:', e);
                    alert('Failed to initialize application. Please try again later.');
                    window.location.href = 'login.html';
                }
            };

            async function syncUserAccess(db, user) {
                try {
                    const meRef = doc(db, 'users', user.uid);
                    const meSnap = await getDoc(meRef);
                    if (!meSnap.exists()) {
                        await setDoc(meRef, { 
                            role: 'staff', 
                            warehouses: [],
                            name: user.displayName || user.email || 'User',
                            email: user.email,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error('syncUserAccess error:', e);
                }
            }

            async function loadCompanyCurrency(db, user) {
                try {
                    const ref = doc(db, `users/${user.uid}/settings`, 'profile');
                    const snap = await getDoc(ref);
                    return snap.exists() ? (snap.data().company?.currency || 'USD') : 'USD';
                } catch { return 'USD'; }
            }

            function currencySymbol(code) {
                const map = { USD: '$', EUR: '€', GBP: '£', INR: '₹', TZS: 'TSh', KES: 'KSh', UGX: 'USh' };
                return map[code] || code + ' ';
            }

            function formatDate(timestamp) {
                if (!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toISOString().split('T')[0];
            }

            async function setupReports(db, user, currencyCode) {
                const reportType = document.getElementById('reportType');
                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');
                const groupBy = document.getElementById('groupBy');
                const search = document.getElementById('search');
                const warehouseFilter = document.getElementById('warehouse');
                const reportsBody = document.getElementById('reports-body');
                let allowedWarehouses = null;
                let warehouses = [];

                // Load user access
                (function loadUserContext(){
                    try {
                        const meRef = doc(db, 'users', user.uid);
                        onSnapshot(meRef, (snap) => {
                            if (snap.exists()) {
                                const u = snap.data();
                                const role = u.role || 'staff';
                                const arr = Array.isArray(u.warehouses) ? u.warehouses.filter(Boolean) : [];
                                allowedWarehouses = (role === 'admin') ? null : arr;
                                loadWarehouses();
                                updateDashboardCards();
                                renderReports();
                            } else {
                                allowedWarehouses = null;
                                loadWarehouses();
                                updateDashboardCards();
                                renderReports();
                            }
                        });
                    } catch (e) { console.error('Failed to load user context', e); }
                })();

                // Load warehouses
                function loadWarehouses() {
                    let q = query(collection(db, 'warehouses'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        q = query(q, where('name', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(q, (snap) => {
                        warehouses = snap.docs.map(d => d.data().name).filter(Boolean);
                        const selects = [document.getElementById('global-warehouse'), warehouseFilter];
                        selects.forEach(sel => {
                            if (!sel) return;
                            const current = sel.value;
                            sel.innerHTML = '<option value="">All</option>';
                            warehouses.forEach(w => {
                                const opt = document.createElement('option');
                                opt.value = w;
                                opt.textContent = w;
                                sel.appendChild(opt);
                            });
                            sel.value = warehouses.includes(current) ? current : '';
                        });
                    }, (error) => {
                        console.error('Error loading warehouses:', error);
                    });
                }

                // Update dashboard cards
                async function updateDashboardCards() {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    let ordersQuery = query(collection(db, 'orders'), where('createdAt', '>=', thirtyDaysAgo));
                    let productsQuery = collection(db, 'products');
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        ordersQuery = query(ordersQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        productsQuery = query(productsQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    }

                    // Sales (30d)
                    const ordersSnap = await getDocs(ordersQuery);
                    let totalSales = 0;
                    let categorySales = {};
                    ordersSnap.forEach(doc => {
                        const order = doc.data();
                        if (order.status === 'paid') {
                            totalSales += Number(order.total || 0);
                            order.items.forEach(item => {
                                categorySales[item.category || 'Unknown'] = (categorySales[item.category || 'Unknown'] || 0) + (item.qty * item.unitPrice);
                            });
                        }
                    });
                    document.querySelector('#sales-card .card-value').textContent = `${currencySymbol(currencyCode)}${totalSales.toFixed(2)}`;
                    document.querySelector('#sales-card .positive').innerHTML = `<i class="fas fa-arrow-up"></i> ${totalSales > 0 ? 'Positive' : '0%'}`;

                    // Top Category
                    const topCategory = Object.entries(categorySales).sort((a, b) => b[1] - a[1])[0];
                    document.querySelector('#top-category-card .card-value').textContent = topCategory ? topCategory[0] : 'None';
                    document.querySelector('#top-category-card .positive').textContent = topCategory ? `${((topCategory[1] / totalSales) * 100).toFixed(1)}% of sales` : '0% of sales';

                    // Low Stock Items
                    const productsSnap = await getDocs(productsQuery);
                    let lowStockCount = 0;
                    productsSnap.forEach(doc => {
                        const product = doc.data();
                        if (product.stock < 20) lowStockCount++;
                    });
                    document.querySelector('#low-stock-card .card-value').textContent = lowStockCount;
                    document.querySelector('#low-stock-card .negative').innerHTML = `<i class="fas fa-arrow-up"></i> ${lowStockCount > 0 ? 'Increased' : '0%'}`;

                    // Cancelled Orders
                    let cancelledOrdersQuery = query(collection(db, 'orders'), where('status', '==', 'cancelled'), where('createdAt', '>=', thirtyDaysAgo));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        cancelledOrdersQuery = query(cancelledOrdersQuery, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    const cancelledSnap = await getDocs(cancelledOrdersQuery);
                    const cancelledCount = cancelledSnap.size;
                    document.querySelector('#cancelled-orders-card .card-value').textContent = cancelledCount;
                    document.querySelector('#cancelled-orders-card .positive').innerHTML = `<i class="fas fa-arrow-down"></i> ${cancelledCount > 0 ? 'Decreased' : '0%'}`;
                }

                // Render reports
                let unsubscribeReports;
                function renderReports() {
                    if (unsubscribeReports) unsubscribeReports();
                    let q = query(collection(db, 'reports'), orderBy('createdAt', 'desc'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    unsubscribeReports = onSnapshot(q, (snap) => {
                        reportsBody.innerHTML = snap.empty ? '<tr><td colspan="5" style="text-align:center; color:#95a5a6;">No reports found.</td></tr>' : '';
                        snap.forEach(doc => {
                            const report = doc.data();
                            const tr = document.createElement('tr');
                            tr.dataset.id = doc.id;
                            tr.innerHTML = `
                                <td>${report.title || 'Untitled'}</td>
                                <td><span class="tag ${report.type || 'sales'}">${(report.type || 'sales').charAt(0).toUpperCase() + (report.type || 'sales').slice(1)}</span></td>
                                <td>${formatDate(report.dateFrom)} → ${formatDate(report.dateTo)}</td>
                                <td>${formatDate(report.createdAt)}</td>
                                <td>
                                    <button class="btn btn-primary btn-view"><i class="fas fa-eye"></i> View</button>
                                    <button class="btn btn-success btn-download"><i class="fas fa-download"></i> Download</button>
                                </td>
                            `;
                            tr.querySelector('.btn-view').onclick = () => {
                                alert(`Viewing: ${report.title}\nType: ${report.type}\nDate Range: ${formatDate(report.dateFrom)} → ${formatDate(report.dateTo)}\nDetails: ${JSON.stringify(report.data, null, 2)}`);
                            };
                            tr.querySelector('.btn-download').onclick = () => downloadReport(doc.id, report);
                            reportsBody.appendChild(tr);
                        });
                        applyFilters();
                    }, (error) => {
                        console.error('Error loading reports:', error);
                        alert('Failed to load reports. Please try again.');
                    });
                }

                // Download report
                async function downloadReport(id, report) {
                    try {
                        const csv = generateReportCSV(report);
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${report.title}_${formatDate(report.createdAt)}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert(`Downloaded: ${report.title}`);
                    } catch (error) {
                        console.error('Error downloading report:', error);
                        alert('Failed to download report. Please try again.');
                    }
                }

                // Generate report CSV
                function generateReportCSV(report) {
                    const headers = ['Item', 'Value'];
                    const rows = Object.entries(report.data || {}).map(([key, value]) => [key, value]);
                    return [headers, ...rows].map(row => row.map(cell => {
                        const text = String(cell ?? '').replace(/\s+/g, ' ').trim();
                        return (text.includes(',') || text.includes('"')) ? `"${text.replace(/"/g, '""')}"` : text;
                    }).join(',')).join('\n');
                }

                // Generate report
                document.getElementById('btn-generate').onclick = async () => {
                    try {
                        const type = reportType.value || 'sales';
                        const from = dateFrom.value ? new Date(dateFrom.value) : new Date();
                        const to = dateTo.value ? new Date(dateTo.value) : new Date();
                        const warehouse = warehouseFilter.value;
                        let data = {};
                        let title = `${type.charAt(0).toUpperCase() + type.slice(1)} Report ${formatDate(from)}`;
                        if (type === 'sales') {
                            let q = query(collection(db, 'orders'), where('date', '>=', from.toISOString().split('T')[0]), where('date', '<=', to.toISOString().split('T')[0]));
                            if (warehouse) q = query(q, where('warehouse', '==', warehouse));
                            if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            const snap = await getDocs(q);
                            data.total = 0;
                            snap.forEach(doc => {
                                const order = doc.data();
                                if (order.status === 'paid') data.total += Number(order.total || 0);
                            });
                        } else if (type === 'inventory') {
                            let q = collection(db, 'products');
                            if (warehouse) q = query(q, where('warehouse', '==', warehouse));
                            if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            const snap = await getDocs(q);
                            data.lowStock = 0;
                            snap.forEach(doc => {
                                if (doc.data().stock < 20) data.lowStock++;
                            });
                        } else if (type === 'supply') {
                            let q = collection(db, 'products');
                            if (warehouse) q = query(q, where('warehouse', '==', warehouse));
                            if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                                q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                            }
                            const snap = await getDocs(q);
                            data.reorderCount = 0;
                            snap.forEach(doc => {
                                if (doc.data().stock < 20) data.reorderCount++;
                            });
                        }
                        await addDoc(collection(db, 'reports'), {
                            title,
                            type,
                            dateFrom: from,
                            dateTo: to,
                            warehouse: warehouse || '',
                            data,
                            createdAt: new Date(),
                            createdBy: user.uid
                        });
                        alert('Report generated successfully.');
                    } catch (error) {
                        console.error('Error generating report:', error);
                        alert('Failed to generate report. Please try again.');
                    }
                };

                // Export reports
                document.getElementById('btn-export').onclick = async () => {
                    try {
                        let q = query(collection(db, 'reports'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        const snap = await getDocs(q);
                        if (snap.empty) {
                            alert('No reports to export.');
                            return;
                        }
                        const headers = ['Title', 'Type', 'Date From', 'Date To', 'Warehouse', 'Created'];
                        const rows = snap.docs.map(doc => {
                            const r = doc.data();
                            return [r.title, r.type, formatDate(r.dateFrom), formatDate(r.dateTo), r.warehouse || 'All', formatDate(r.createdAt)];
                        });
                        const csv = [headers, ...rows].map(row => row.map(cell => {
                            const text = String(cell ?? '').replace(/\s+/g, ' ').trim();
                            return (text.includes(',') || text.includes('"')) ? `"${text.replace(/"/g, '""')}"` : text;
                        }).join(',')).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Reports exported successfully.');
                    } catch (error) {
                        console.error('Error exporting reports:', error);
                        alert('Failed to export reports. Please try again.');
                    }
                };

                // Apply filters
                function applyFilters() {
                    const typeVal = reportType.value;
                    const fromVal = dateFrom.value ? new Date(dateFrom.value) : null;
                    const toVal = dateTo.value ? new Date(dateTo.value) : null;
                    const warehouseVal = warehouseFilter.value;
                    const query = search.value.toLowerCase();
                    const rows = reportsBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        if (!row || row.children.length < 5) return;
                        const title = row.children[0].textContent.toLowerCase();
                        const tagEl = row.querySelector('.tag');
                        const rowType = tagEl.classList.contains('sales') ? 'sales' : tagEl.classList.contains('inventory') ? 'inventory' : 'supply';
                        const range = row.children[2].textContent.split('→').map(s => s.trim());
                        const start = new Date(range[0]);
                        const end = new Date(range[1]);
                        const warehouse = row.dataset.warehouse || '';
                        let visible = true;
                        if (typeVal && rowType !== typeVal) visible = false;
                        if (fromVal && end < fromVal) visible = false;
                        if (toVal && start > toVal) visible = false;
                        if (warehouseVal && warehouse !== warehouseVal) visible = false;
                        if (query && !title.includes(query)) visible = false;
                        row.style.display = visible ? '' : 'none';
                    });
                }

                // Bind filter events
                [reportType, dateFrom, dateTo, groupBy, warehouseFilter, search].forEach(el => el.addEventListener('change', applyFilters));
                search.addEventListener('keyup', applyFilters);

                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const href = item.dataset.href;
                        if (href) window.location.href = href;
                    });
                });

                // Mobile sidebar toggle
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        sidebar.classList.toggle('mobile-hidden');
                        sidebar.classList.toggle('mobile-visible');
                        overlay.style.display = sidebar.classList.contains('mobile-visible') ? 'block' : 'none';
                    };
                }
                if (overlay) {
                    overlay.onclick = () => {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                        overlay.style.display = 'none';
                    };
                }

                // Initialize global warehouse dropdown
                (function initGlobalWarehouse(){
                    const select = document.getElementById('global-warehouse');
                    if (!select) {
                        loadWarehouses();
                        updateDashboardCards();
                        renderReports();
                        return;
                    }
                    const saved = localStorage.getItem('selectedWarehouse') || '';
                    onSnapshot(query(collection(db, 'warehouses'), orderBy('name')), (snap) => {
                        const names = snap.docs.map(d => d.data().name).filter(Boolean);
                        select.innerHTML = '';
                        const allOpt = document.createElement('option');
                        allOpt.value = '';
                        allOpt.textContent = 'All Warehouses';
                        select.appendChild(allOpt);
                        names.forEach(n => {
                            const opt = document.createElement('option');
                            opt.value = n;
                            opt.textContent = n;
                            select.appendChild(opt);
                        });
                        select.value = names.includes(saved) ? saved : '';
                        const pageFilter = document.getElementById('warehouse');
                        if (pageFilter) pageFilter.value = select.value;
                        updateDashboardCards();
                        renderReports();
                    });
                    select.addEventListener('change', () => {
                        localStorage.setItem('selectedWarehouse', select.value);
                        const pageFilter = document.getElementById('warehouse');
                        if (pageFilter && pageFilter.value !== select.value) pageFilter.value = select.value;
                        updateDashboardCards();
                        renderReports();
                    });
                })();
            }

            init();
        })();
    </script>
</body>
</html>