<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Transfers - StockMaster</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .sidebar {
            background: var(--primary);
            color: #fff;
            padding: 20px 0;
            width: 250px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        
        .sidebar.mobile-hidden {
            transform: translateX(-250px);
        }
        
        .sidebar.mobile-visible {
            transform: translateX(0);
        }
        
        .logo {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo span {
            color: var(--secondary);
        }
        
        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary);
        }
        
        .menu-item i {
            margin-right: 15px;
            font-size: 18px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background: #f5f7fa;
            border-radius: 4px;
            padding: 8px 15px;
            width: 300px;
        }
        
        .search-bar input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 5px;
            outline: none;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
            color: #fff;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        label {
            font-size: 12px;
            color: var(--gray);
        }
        
        input[type="text"], input[type="date"], select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            color: var(--gray);
            background: #f9f9f9;
            font-weight: 600;
        }
        
        .icon-btn {
            padding: 6px;
            border-radius: 4px;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        
        .btn-add {
            background: var(--success);
        }
        
        .btn-remove {
            background: var(--danger);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .summary {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            color: var(--gray);
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                transform: translateX(-250px);
            }
            
            .sidebar.mobile-visible {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-bar {
                width: 100%;
                margin-bottom: 15px;
            }
            
            #mobile-menu-btn {
                display: block !important;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <select id="global-warehouse" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid rgba(255,255,255,.3); background:#1f2d3a; color:#fff; margin-bottom:8px;"></select>
                <h1>Stock<span>Master</span></h1>
            </div>
            <div class="menu-item" data-href="index.html">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-href="products.html">
                <i class="fas fa-boxes"></i>
                <span>Products</span>
            </div>
            <div class="menu-item" data-href="inventory.html">
                <i class="fas fa-warehouse"></i>
                <span>Inventory</span>
            </div>
            <div class="menu-item active" data-href="transfers.html">
                <i class="fas fa-exchange-alt"></i>
                <span>Transfers</span>
            </div>
            <div class="menu-item" data-href="orders.html">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Orders</span>
            </div>
            <div class="menu-item" data-href="reports.html">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </div>
            <div class="menu-item" data-href="suppliers.html">
                <i class="fas fa-users"></i>
                <span>Suppliers</span>
            </div>
            <div class="menu-item" data-href="settings.html">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" data-href="help.html">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
        <div class="main-content">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%; gap:8px;">
                    <button id="mobile-menu-btn" style="display:none; border:none; background:transparent; font-size:22px; margin-right:10px; cursor:pointer;">☰</button>
                    <div class="search-bar" style="flex:1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-bar" placeholder="Search transfers...">
                    </div>
                </div>
                <div class="user-profile" id="user-profile">
                    <div style="margin-right:10px;">
                        <div id="user-name">User</div>
                        <small id="user-role">Authenticated</small>
                    </div>
                    <button id="btn-logout" class="btn" style="background:#fff; color:#e74c3c; border:1px solid #e74c3c; padding:8px 10px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>

            <div class="page-header">
                <h2 class="page-title">New Stock Transfer</h2>
                <div class="actions">
                    <button class="btn btn-primary" id="btn-save"><i class="fas fa-save"></i> Save Draft</button>
                    <button class="btn btn-success" id="btn-submit"><i class="fas fa-paper-plane"></i> Submit Transfer</button>
                </div>
            </div>

            <div class="card">
                <div class="form-row">
                    <div class="form-group">
                        <label>Transfer Number</label>
                        <input type="text" id="trf_number" readonly>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="trf_date">
                    </div>
                </div>
                <div class="form-row" style="margin-top:12px;">
                    <div class="form-group">
                        <label>From Warehouse</label>
                        <select id="from_wh">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To Warehouse</label>
                        <select id="to_wh">
                            <option value="">Select...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="margin-top:12px;">
                    <div class="form-group" style="grid-column:1 / -1;">
                        <label>Notes</label>
                        <textarea id="trf_notes" placeholder="Add any special instructions..."></textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Items</h3>
                    <button class="icon-btn btn-add" id="btn-add-row"><i class="fas fa-plus"></i> Add Item</button>
                </div>
                <div class="table-wrapper">
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Available</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="summary">
                    <div>Total Items: <span id="sum-rows">0</span></div>
                    <div>Total Quantity: <span id="sum-qty">0</span></div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Draft Transfers</h3>
                    <small style="color:#95a5a6;">Saved in Firestore</small>
                </div>
                <div id="drafts-list"></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Confirmed Transfers</h3>
                    <button class="btn btn-success" id="btn-export-confirmed"><i class="fas fa-file-export"></i> Export CSV</button>
                </div>
                <div id="confirmed-list"></div>
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:900;"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where, runTransaction, getDocs, setDoc, setLogLevel } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        (function(){
            const setHeader = (displayName, email) => {
                const name = displayName || email || 'User';
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
                const nameEl = document.getElementById('user-name');
                const avatarEl = document.getElementById('user-avatar');
                if (nameEl) nameEl.textContent = name;
                if (avatarEl) avatarEl.src = avatar;
            };

            const init = async () => {
                try {
                    const app = initializeApp({ 
                        apiKey: "AIzaSyAqBR_6p-5752sVeu_aMT2sNU2I_nUmaOQ", 
                        authDomain: "inventory-3b638.firebaseapp.com", 
                        projectId: "inventory-3b638", 
                        storageBucket: "inventory-3b638.firebasestorage.app", 
                        messagingSenderId: "65748912542", 
                        appId: "1:65748912542:web:8d40510d194bb3e1d6ae8f", 
                        measurementId: "G-6ECQLDLS71" 
                    });
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    setLogLevel('error');
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            window.location.href = 'login.html';
                            return;
                        }
                        setHeader(user.displayName, user.email);
                        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.href = 'login.html');
                        await syncUserAccess(db, user);
                        const currency = await loadCompanyCurrency(db, user);
                        setupTransfers(db, user, currency);
                    });
                } catch (e) {
                    console.error('Firebase initialization failed:', e);
                    alert('Failed to initialize application. Please try again later.');
                    window.location.href = 'login.html';
                }
            };

            async function syncUserAccess(db, user) {
                try {
                    const meRef = doc(db, 'users', user.uid);
                    const { getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
                    const meSnap = await getDoc(meRef);
                    if (!meSnap.exists()) {
                        await setDoc(meRef, { 
                            role: 'staff', 
                            warehouses: [],
                            name: user.displayName || user.email || 'User',
                            email: user.email,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error('syncUserAccess error:', e);
                }
            }

            async function loadCompanyCurrency(db, user) {
                try {
                    const ref = doc(db, `users/${user.uid}/settings`, 'profile');
                    const { getDoc } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
                    const snap = await getDoc(ref);
                    return snap.exists() ? (snap.data().company?.currency || 'USD') : 'USD';
                } catch { return 'USD'; }
            }

            function currencySymbol(code) {
                const map = { USD: '$', EUR: '€', GBP: '£', INR: '₹', TZS: 'TSh', KES: 'KSh', UGX: 'USh' };
                return map[code] || code + ' ';
            }

            async function setupTransfers(db, user, currencyCode) {
                const tableBody = document.querySelector('#items-table tbody');
                const draftsList = document.getElementById('drafts-list');
                const confirmedList = document.getElementById('confirmed-list');
                const trfNumber = document.getElementById('trf_number');
                const trfDate = document.getElementById('trf_date');
                const fromWh = document.getElementById('from_wh');
                const toWh = document.getElementById('to_wh');
                const trfNotes = document.getElementById('trf_notes');
                let products = [];
                let warehouses = [];
                let allowedWarehouses = null;

                // Set default date to today
                trfDate.value = new Date().toISOString().split('T')[0];

                // Load user access
                (function loadUserContext(){
                    try {
                        const meRef = doc(db, 'users', user.uid);
                        onSnapshot(meRef, (snap) => {
                            if (snap.exists()) {
                                const u = snap.data();
                                const role = u.role || 'staff';
                                const arr = Array.isArray(u.warehouses) ? u.warehouses.filter(Boolean) : [];
                                allowedWarehouses = (role === 'admin') ? null : arr;
                                loadWarehouses();
                            } else {
                                allowedWarehouses = null;
                                loadWarehouses();
                            }
                        });
                    } catch (e) { console.error('Failed to load user context', e); }
                })();

                // Generate unique transfer number
                async function generateTransferNumber() {
                    const year = new Date().getFullYear();
                    const qy = query(collection(db, 'transfers'), where('number', '>=', `TRF-${year}-`), where('number', '<=', `TRF-${year}-\uf8ff`));
                    const snap = await getDocs(qy);
                    const transfers = snap.docs.map(d => d.data().number).filter(Boolean);
                    const lastNum = transfers
                        .filter(n => n.startsWith(`TRF-${year}-`))
                        .map(n => parseInt(n.split('-')[2] || '0', 10))
                        .sort((a, b) => b - a)[0] || 0;
                    return `TRF-${year}-${String(lastNum + 1).padStart(4, '0')}`;
                }

                // Load products for dropdown (optionally filtered by a warehouse)
                function loadProducts(warehouse = '') {
                    let qy = query(collection(db, 'products'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        qy = query(qy, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    } else if (warehouse) {
                        qy = query(qy, where('warehouse', '==', warehouse));
                    }
                    onSnapshot(qy, (snap) => {
                        products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Refresh table to update available stock
                        const rows = tableBody.querySelectorAll('tr');
                        rows.forEach(row => {
                            const select = row.querySelector('.product');
                            const selectedId = select.value;
                            const product = products.find(p => p.id === selectedId);
                            row.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                            row.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                        });
                    }, (error) => {
                        console.error('Error loading products:', error);
                        alert('Failed to load products. Please try again.');
                    });
                }

                // Load warehouses into From/To selects
                function loadWarehouses() {
                    let qy = query(collection(db, 'warehouses'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        qy = query(qy, where('name', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(qy, (snap) => {
                        warehouses = snap.docs.map(d => d.data().name).filter(Boolean);
                        const fromSel = fromWh; const toSel = toWh;
                        const currentFrom = fromSel.value; const currentTo = toSel.value;
                        const rebuild = (sel, current) => {
                            sel.innerHTML = '';
                            const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'Select...'; sel.appendChild(opt);
                            warehouses.forEach(w => { const o = document.createElement('option'); o.value = w; o.textContent = w; sel.appendChild(o); });
                            if (warehouses.includes(current)) sel.value = current; else sel.value = '';
                        };
                        rebuild(fromSel, currentFrom);
                        rebuild(toSel, currentTo);
                    }, (error) => {
                        console.error('Error loading warehouses for transfer:', error);
                    });
                }

                // Recalculate summary
                function recalc() {
                    const rows = tableBody.querySelectorAll('tr');
                    let totalQty = 0;
                    rows.forEach(r => {
                        totalQty += Number(r.querySelector('.qty').value || 0);
                    });
                    document.getElementById('sum-rows').textContent = rows.length;
                    document.getElementById('sum-qty').textContent = totalQty;
                }

                // Add table row
                function addRow(data = { productId: '', qty: 1, unit: 'pcs', notes: '' }) {
                    const tr = document.createElement('tr');
                    const product = products.find(p => p.id === data.productId) || {};
                    tr.innerHTML = `
                        <td><select class="product"></select></td>
                        <td class="sku">${product.sku || ''}</td>
                        <td class="available">${product.stock || 0}</td>
                        <td><input type="number" class="qty" min="1" value="${data.qty}"></td>
                        <td><select class="unit"><option value="pcs" ${data.unit === 'pcs' ? 'selected' : ''}>pcs</option><option value="box" ${data.unit === 'box' ? 'selected' : ''}>box</option></select></td>
                        <td><input type="text" class="row-notes" value="${data.notes}"></td>
                        <td><button class="icon-btn btn-remove"><i class="fas fa-trash"></i></button></td>
                    `;
                    const select = tr.querySelector('.product');
                    products.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name || 'Unnamed';
                        if (p.id === data.productId) opt.selected = true;
                        select.appendChild(opt);
                    });
                    tableBody.appendChild(tr);
                    bindRow(tr);
                    recalc();
                }

                // Bind row events
                function bindRow(tr) {
                    const select = tr.querySelector('.product');
                    const qtyInput = tr.querySelector('.qty');
                    select.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        tr.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                        tr.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                        const qty = Number(qtyInput.value || 0);
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity adjusted to available stock.');
                        }
                        recalc();
                    });
                    qtyInput.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        const qty = Number(qtyInput.value || 0);
                        if (qty < 1) {
                            qtyInput.value = 1;
                            alert('Quantity must be at least 1.');
                        }
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity cannot exceed available stock.');
                        }
                        recalc();
                    });
                    tr.querySelector('.btn-remove').addEventListener('click', () => {
                        tr.remove();
                        recalc();
                    });
                }

                // Validate form
                function validateForm() {
                    const from = fromWh.value;
                    const to = toWh.value;
                    if (!from || !to) {
                        alert('Select both source and destination warehouses.');
                        return false;
                    }
                    if (from === to) {
                        alert('Source and destination cannot be the same.');
                        return false;
                    }
                    const rows = tableBody.querySelectorAll('tr');
                    if (rows.length === 0) {
                        alert('Add at least one item.');
                        return false;
                    }
                    for (const row of rows) {
                        const productId = row.querySelector('.product').value;
                        const qty = Number(row.querySelector('.qty').value || 0);
                        if (!productId) {
                            alert('Each row must have a selected product.');
                            return false;
                        }
                        if (qty < 1) {
                            alert('Quantity must be at least 1.');
                            return false;
                        }
                        const product = products.find(p => p.id === productId);
                        if (product && qty > (product.stock || 0)) {
                            alert(`Quantity for ${product.name || 'product'} exceeds available stock.`);
                            return false;
                        }
                        if (product && product.warehouse !== from) {
                            alert(`Product ${product.name || 'product'} is not in the source warehouse (${from}).`);
                            return false;
                        }
                    }
                    return true;
                }

                // Serialize form data
                function serializeTransfer() {
                    const number = trfNumber.value;
                    const date = trfDate.value;
                    const from = fromWh.value;
                    const to = toWh.value;
                    const notes = trfNotes.value;
                    const items = Array.from(tableBody.querySelectorAll('tr')).map(row => {
                        const productId = row.querySelector('.product').value;
                        const product = products.find(p => p.id === productId);
                        return {
                            productId,
                            sku: product ? product.sku || '' : '',
                            name: product ? product.name || '' : '',
                            qty: Number(row.querySelector('.qty').value || 0),
                            unit: row.querySelector('.unit').value,
                            notes: row.querySelector('.row-notes').value
                        };
                    }).filter(item => item.productId && item.qty > 0);
                    if (!from || !to || !items.length) return null;
                    return { number, date, from, to, notes, items };
                }

                // Render drafts and confirmed lists
                function renderLists() {
                    let draftsQ = query(collection(db, 'transfers'), where('status', '==', 'draft'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        draftsQ = query(draftsQ, where('from', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(draftsQ, (snap) => {
                        const docs = snap.docs
                            .map(d => ({ id: d.id, ...d.data() }))
                            .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        draftsList.innerHTML = docs.length ? '' : '<div style="color:#95a5a6;">No drafts yet.</div>';
                        docs.forEach(t => {
                            const wrap = document.createElement('div');
                            wrap.style.display = 'flex';
                            wrap.style.alignItems = 'center';
                            wrap.style.justifyContent = 'space-between';
                            wrap.style.padding = '10px 0';
                            wrap.style.borderBottom = '1px solid #eee';
                            const when = t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000).toLocaleString() : '';
                            wrap.innerHTML = `
                                <div>
                                    <div style="font-weight:600;">${t.number}</div>
                                    <div style="font-size:12px; color:#95a5a6;">${t.from} → ${t.to} • ${t.items.length} items • ${when}</div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-primary btn-small" data-action="load">Load</button>
                                    <button class="btn btn-success btn-small" data-action="confirm">Confirm</button>
                                    <button class="btn btn-danger btn-small" data-action="delete">Delete</button>
                                </div>
                            `;
                            wrap.querySelector('[data-action="load"]').onclick = () => loadIntoForm(t);
                            wrap.querySelector('[data-action="confirm"]').onclick = () => confirmDraft(t.id, t);
                            wrap.querySelector('[data-action="delete"]').onclick = () => deleteDraft(t.id, t.number);
                            draftsList.appendChild(wrap);
                        });
                    }, (error) => {
                        console.error('Error loading drafts:', error);
                        alert('Failed to load drafts. Please try again.');
                    });

                    let confirmedQ = query(collection(db, 'transfers'), where('status', '==', 'confirmed'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        confirmedQ = query(confirmedQ, where('from', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(confirmedQ, (snap) => {
                        const docs = snap.docs
                            .map(d => ({ id: d.id, ...d.data() }))
                            .sort((a, b) => (b.confirmedAt?.seconds || 0) - (a.confirmedAt?.seconds || 0));
                        confirmedList.innerHTML = docs.length ? '' : '<div style="color:#95a5a6;">No confirmed transfers yet.</div>';
                        docs.forEach(t => {
                            const wrap = document.createElement('div');
                            wrap.style.display = 'flex';
                            wrap.style.alignItems = 'center';
                            wrap.style.justifyContent = 'space-between';
                            wrap.style.padding = '10px 0';
                            wrap.style.borderBottom = '1px solid #eee';
                            const when = t.confirmedAt?.seconds ? new Date(t.confirmedAt.seconds * 1000).toLocaleString() : '';
                            wrap.innerHTML = `
                                <div>
                                    <div style="font-weight:600;">${t.number}</div>
                                    <div style="font-size:12px; color:#95a5a6;">${t.from} → ${t.to} • ${t.items.length} items • ${when}</div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-primary btn-small" data-action="view">View</button>
                                </div>
                            `;
                            wrap.querySelector('[data-action="view"]').onclick = () => {
                                const itemsList = t.items.map(i => `${i.sku || ''} ${i.name} x${i.qty} ${i.unit}`).join('\n');
                                alert(`Transfer ${t.number}\n${t.from} → ${t.to}\nItems:\n${itemsList}\nNotes: ${t.notes || 'None'}`);
                            };
                            confirmedList.appendChild(wrap);
                        });
                    }, (error) => {
                        console.error('Error loading confirmed transfers:', error);
                        alert('Failed to load confirmed transfers. Please try again.');
                    });
                }

                // Load transfer into form
                function loadIntoForm(t) {
                    trfNumber.value = t.number;
                    trfDate.value = t.date || new Date().toISOString().split('T')[0];
                    fromWh.value = t.from;
                    toWh.value = t.to;
                    trfNotes.value = t.notes || '';
                    tableBody.innerHTML = '';
                    t.items.forEach(item => addRow({ productId: item.productId, qty: item.qty, unit: item.unit, notes: item.notes }));
                    recalc();
                }

                // Confirm draft
                async function confirmDraft(id, t) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const transferRef = doc(db, 'transfers', id);
                            const transferDoc = await transaction.get(transferRef);
                            if (!transferDoc.exists()) throw new Error('Transfer not found.');
                            for (const item of t.items) {
                                const productRef = doc(db, 'products', item.productId);
                                const productDoc = await transaction.get(productRef);
                                if (!productDoc.exists()) throw new Error(`Product ${item.name} not found.`);
                                const product = productDoc.data();
                                if (product.warehouse !== t.from) throw new Error(`Product ${item.name} is not in warehouse ${t.from}.`);
                                if (item.qty > (product.stock || 0)) throw new Error(`Insufficient stock for ${item.name}.`);
                                // Update source product
                                transaction.update(productRef, {
                                    stock: (product.stock || 0) - item.qty,
                                    status: (product.stock - item.qty) === 0 ? 'out-of-stock' : (product.stock - item.qty) < 20 ? 'low-stock' : 'in-stock',
                                    updatedAt: serverTimestamp(),
                                    updatedBy: user.uid
                                });
                                // Find or create destination product
                                const destProductQ = query(collection(db, 'products'), where('sku', '==', product.sku));
                                const destSnap = await getDocs(destProductQ);
                                const destFiltered = destSnap.docs.filter(d => (d.data().warehouse || '') === t.to);
                                let destProductRef;
                                if (destFiltered.length === 0) {
                                    destProductRef = doc(collection(db, 'products'));
                                    transaction.set(destProductRef, {
                                        name: product.name,
                                        sku: product.sku,
                                        category: product.category,
                                        price: product.price,
                                        stock: item.qty,
                                        status: item.qty < 20 ? 'low-stock' : 'in-stock',
                                        warehouse: t.to,
                                        createdAt: serverTimestamp(),
                                        createdBy: user.uid,
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                } else {
                                    destProductRef = destFiltered[0].ref;
                                    const destProduct = destFiltered[0].data();
                                    transaction.update(destProductRef, {
                                        stock: (destProduct.stock || 0) + item.qty,
                                        status: ((destProduct.stock || 0) + item.qty) < 20 ? 'low-stock' : 'in-stock',
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                }
                            }
                            transaction.update(transferRef, {
                                status: 'confirmed',
                                confirmedAt: serverTimestamp(),
                                updatedAt: serverTimestamp(),
                                updatedBy: user.uid
                            });
                        });
                        alert(`Transfer ${t.number} confirmed.`);
                        resetForm();
                    } catch (error) {
                        console.error('Error confirming transfer:', error);
                        alert(`Failed to confirm transfer: ${error.message}`);
                    }
                }

                // Delete draft
                async function deleteDraft(id, number) {
                    if (!confirm(`Delete draft ${number}?`)) return;
                    try {
                        await deleteDoc(doc(db, 'transfers', id));
                        alert(`Draft ${number} deleted.`);
                    } catch (error) {
                        console.error('Error deleting draft:', error);
                        alert('Failed to delete draft. Please try again.');
                    }
                }

                // Reset form
                function resetForm() {
                    generateTransferNumber().then(num => trfNumber.value = num);
                    trfDate.value = new Date().toISOString().split('T')[0];
                    fromWh.value = '';
                    toWh.value = '';
                    trfNotes.value = '';
                    tableBody.innerHTML = '';
                    recalc();
                }

                // Save draft
                document.getElementById('btn-save').onclick = async () => {
                    if (!validateForm()) return;
                    const payload = serializeTransfer();
                    if (!payload) return;
                    try {
                        await addDoc(collection(db, 'transfers'), {
                            ...payload,
                            status: 'draft',
                            createdAt: serverTimestamp(),
                            createdBy: user.uid,
                            updatedAt: serverTimestamp(),
                            updatedBy: user.uid
                        });
                        alert('Transfer saved as draft.');
                        resetForm();
                    } catch (error) {
                        console.error('Error saving draft:', error);
                        alert('Failed to save draft. Please try again.');
                    }
                };

                // Submit transfer
                document.getElementById('btn-submit').onclick = async () => {
                    if (!validateForm()) return;
                    const payload = serializeTransfer();
                    if (!payload) return;
                    try {
                        await runTransaction(db, async (transaction) => {
                            const transferRef = doc(collection(db, 'transfers'));
                            for (const item of payload.items) {
                                const productRef = doc(db, 'products', item.productId);
                                const productDoc = await transaction.get(productRef);
                                if (!productDoc.exists()) throw new Error(`Product ${item.name} not found.`);
                                const product = productDoc.data();
                                if (product.warehouse !== payload.from) throw new Error(`Product ${item.name} is not in warehouse ${payload.from}.`);
                                if (item.qty > (product.stock || 0)) throw new Error(`Insufficient stock for ${item.name}.`);
                                // Update source product
                                transaction.update(productRef, {
                                    stock: (product.stock || 0) - item.qty,
                                    status: (product.stock - item.qty) === 0 ? 'out-of-stock' : (product.stock - item.qty) < 20 ? 'low-stock' : 'in-stock',
                                    updatedAt: serverTimestamp(),
                                    updatedBy: user.uid
                                });
                                // Find or create destination product
                                const destProductQ = query(collection(db, 'products'), where('sku', '==', product.sku));
                                const destSnap = await getDocs(destProductQ);
                                const destFiltered = destSnap.docs.filter(d => (d.data().warehouse || '') === payload.to);
                                let destProductRef;
                                if (destFiltered.length === 0) {
                                    destProductRef = doc(collection(db, 'products'));
                                    transaction.set(destProductRef, {
                                        name: product.name,
                                        sku: product.sku,
                                        category: product.category,
                                        price: product.price,
                                        stock: item.qty,
                                        status: item.qty < 20 ? 'low-stock' : 'in-stock',
                                        warehouse: payload.to,
                                        createdAt: serverTimestamp(),
                                        createdBy: user.uid,
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                } else {
                                    destProductRef = destFiltered[0].ref;
                                    const destProduct = destFiltered[0].data();
                                    transaction.update(destProductRef, {
                                        stock: (destProduct.stock || 0) + item.qty,
                                        status: ((destProduct.stock || 0) + item.qty) < 20 ? 'low-stock' : 'in-stock',
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                }
                            }
                            transaction.set(transferRef, {
                                ...payload,
                                status: 'confirmed',
                                createdAt: serverTimestamp(),
                                createdBy: user.uid,
                                updatedAt: serverTimestamp(),
                                updatedBy: user.uid,
                                confirmedAt: serverTimestamp()
                            });
                        });
                        alert('Transfer submitted successfully.');
                        resetForm();
                    } catch (error) {
                        console.error('Error submitting transfer:', error);
                        alert(`Failed to submit transfer: ${error.message}`);
                    }
                };

                // Add row
                document.getElementById('btn-add-row').onclick = () => {
                    if (!products.length) {
                        alert('No products available. Please add products first.');
                        return;
                    }
                    addRow();
                };

                // Export confirmed transfers
                document.getElementById('btn-export-confirmed').onclick = async () => {
                    try {
                        let qy = query(collection(db, 'transfers'), where('status', '==', 'confirmed'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            qy = query(qy, where('from', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        const snap = await getDocs(qy);
                        if (snap.empty) {
                            alert('No confirmed transfers to export.');
                            return;
                        }
                        const headers = ['Number', 'Date', 'From', 'To', 'Item Count', 'Items', 'Notes'];
                        const rows = snap.docs.map(d => {
                            const t = d.data();
                            const itemsStr = t.items.map(i => `${i.sku || ''} ${i.name} x${i.qty} ${i.unit}`).join(' | ');
                            return [t.number, t.date || '', t.from, t.to, t.items.length, itemsStr, t.notes || ''];
                        });
                        const csv = [headers, ...rows].map(row => row.map(cell => {
                            const text = String(cell ?? '').replace(/\s+/g, ' ').trim();
                            return (text.includes(',') || text.includes('"')) ? `"${text.replace(/"/g, '""')}"` : text;
                        }).join(',')).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `confirmed_transfers_${new Date().toISOString().split('T')[0]}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Confirmed transfers exported successfully.');
                    } catch (error) {
                        console.error('Error exporting transfers:', error);
                        alert('Failed to export transfers. Please try again.');
                    }
                };

                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const href = item.dataset.href;
                        if (href) window.location.href = href;
                    });
                });

                // Mobile sidebar toggle
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        sidebar.classList.toggle('mobile-hidden');
                        sidebar.classList.toggle('mobile-visible');
                        overlay.style.display = sidebar.classList.contains('mobile-visible') ? 'block' : 'none';
                    };
                }
                if (overlay) {
                    overlay.onclick = () => {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                        overlay.style.display = 'none';
                    };
                }

                // Search bar
                document.getElementById('search-bar').addEventListener('input', () => {
                    const search = document.getElementById('search-bar').value.toLowerCase();
                    const draftItems = draftsList.querySelectorAll('div');
                    const confirmedItems = confirmedList.querySelectorAll('div');
                    draftItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = search ? text.includes(search) ? '' : 'none' : '';
                    });
                    confirmedItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = search ? text.includes(search) ? '' : 'none' : '';
                    });
                });

                // Initialize global warehouse dropdown and sync
                (function initGlobalWarehouse(){
                    const select = document.getElementById('global-warehouse');
                    if (!select) { 
                        generateTransferNumber().then(num => trfNumber.value = num); 
                        loadProducts(); 
                        renderLists(); 
                        return; 
                    }
                    const saved = localStorage.getItem('selectedWarehouse') || '';
                    onSnapshot(query(collection(db, 'warehouses'), orderBy('name')),(snap)=>{
                        const names = snap.docs.map(d => d.data().name).filter(Boolean);
                        select.innerHTML = '';
                        const allOpt = document.createElement('option'); allOpt.value = ''; allOpt.textContent = 'All Warehouses';
                        select.appendChild(allOpt);
                        names.forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; select.appendChild(opt); });
                        select.value = names.includes(saved) ? saved : '';
                        // If a global warehouse is chosen, prefill From and filter products
                        if (select.value) {
                            fromWh.value = select.value;
                            loadProducts(select.value);
                        } else {
                            loadProducts();
                        }
                        generateTransferNumber().then(num => trfNumber.value = num);
                        renderLists();
                    });
                    select.addEventListener('change', () => {
                        localStorage.setItem('selectedWarehouse', select.value);
                        if (select.value) {
                            fromWh.value = select.value;
                            loadProducts(select.value);
                        } else {
                            if (fromWh.value) fromWh.value = '';
                            loadProducts();
                        }
                    });
                })();
            }

            init();
        })();
    </script>
</body>
</html>