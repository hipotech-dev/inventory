<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Transfers - StockMaster</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .sidebar {
            background: var(--primary);
            color: #fff;
            padding: 20px 0;
            width: 250px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        
        .sidebar.mobile-hidden {
            transform: translateX(-250px);
        }
        
        .sidebar.mobile-visible {
            transform: translateX(0);
        }
        
        .logo {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo span {
            color: var(--secondary);
        }
        
        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary);
        }
        
        .menu-item i {
            margin-right: 15px;
            font-size: 18px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background: #f5f7fa;
            border-radius: 4px;
            padding: 8px 15px;
            width: 300px;
        }
        
        .search-bar input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 5px;
            outline: none;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
            color: #fff;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #fff;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        label {
            font-size: 12px;
            color: var(--gray);
        }
        
        input[type="text"], input[type="date"], select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            color: var(--gray);
            background: #f9f9f9;
            font-weight: 600;
        }
        
        .icon-btn {
            padding: 6px;
            border-radius: 4px;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        
        .btn-add {
            background: var(--success);
        }
        
        .btn-remove {
            background: var(--danger);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .summary {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            color: var(--gray);
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-draft {
            background: #f1c40f;
            color: #000;
        }
        
        .status-confirmed {
            background: #2ecc71;
            color: white;
        }
        
        .status-completed {
            background: #3498db;
            color: white;
        }
        
        .status-cancelled {
            background: #e74c3c;
            color: white;
        }
        
        .transfer-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            background: #fff;
            transition: box-shadow 0.3s;
        }
        
        .transfer-card:hover {
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }
        
        .transfer-header {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .transfer-body {
            padding: 15px;
        }
        
        .transfer-footer {
            padding: 10px 15px;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .items-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #95a5a6;
        }
        
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                transform: translateX(-250px);
            }
            
            .sidebar.mobile-visible {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .items-list {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-bar {
                width: 100%;
                margin-bottom: 15px;
            }
            
            #mobile-menu-btn {
                display: block !important;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .transfer-header, .transfer-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <select id="global-warehouse" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid rgba(255,255,255,.3); background:#1f2d3a; color:#fff; margin-bottom:8px;"></select>
                <h1>Stock<span>Master</span></h1>
            </div>
            <div class="menu-item" data-href="/index">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-href="/products">
                <i class="fas fa-boxes"></i>
                <span>Products</span>
            </div>
            <div class="menu-item" data-href="inventory">
                <i class="fas fa-warehouse"></i>
                <span>Inventory</span>
            </div>
            <div class="menu-item active" data-href="/transfers">
                <i class="fas fa-exchange-alt"></i>
                <span>Transfers</span>
            </div>
            <div class="menu-item" data-href="/orders">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Orders</span>
            </div>
            <div class="menu-item" data-href="/reports">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </div>
            <div class="menu-item" data-href="/suppliers">
                <i class="fas fa-users"></i>
                <span>Suppliers</span>
            </div>
            <div class="menu-item" data-href="/settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" data-href="/help">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
        <div class="main-content">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%; gap:8px;">
                    <button id="mobile-menu-btn" style="display:none; border:none; background:transparent; font-size:22px; margin-right:10px; cursor:pointer;">☰</button>
                    <div class="search-bar" style="flex:1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-bar" placeholder="Search transfers...">
                    </div>
                </div>
                <div class="user-profile" id="user-profile">
                    <div style="margin-right:10px;">
                        <div id="user-name">User</div>
                        <small id="user-role">Authenticated</small>
                    </div>
                    <button id="btn-logout" class="btn" style="background:#fff; color:#e74c3c; border:1px solid #e74c3c; padding:8px 10px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>

            <div class="page-header">
                <h2 class="page-title">New Stock Transfer</h2>
                <div class="actions">
                    <button class="btn btn-primary" id="btn-save"><i class="fas fa-save"></i> Save Draft</button>
                    <button class="btn btn-success" id="btn-submit"><i class="fas fa-paper-plane"></i> Submit Transfer</button>
                </div>
            </div>

            <div class="card">
                <div class="form-row">
                    <div class="form-group">
                        <label>Transfer Number</label>
                        <input type="text" id="trf_number" readonly>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="trf_date">
                    </div>
                </div>
                <div class="form-row" style="margin-top:12px;">
                    <div class="form-group">
                        <label>From Warehouse</label>
                        <select id="from_wh">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To Warehouse</label>
                        <select id="to_wh">
                            <option value="">Select...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="margin-top:12px;">
                    <div class="form-group" style="grid-column:1 / -1;">
                        <label>Notes</label>
                        <textarea id="trf_notes" placeholder="Add any special instructions..."></textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Items</h3>
                    <button class="icon-btn btn-add" id="btn-add-row"><i class="fas fa-plus"></i> Add Item</button>
                </div>
                <div class="table-wrapper">
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Available</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="summary">
                    <div>Total Items: <span id="sum-rows">0</span></div>
                    <div>Total Quantity: <span id="sum-qty">0</span></div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Draft Transfers</h3>
                    <small style="color:#95a5a6;">Saved in Firestore</small>
                </div>
                <div id="drafts-list" class="transfers-list"></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="font-size:18px;">Confirmed Transfers</h3>
                    <button class="btn btn-success" id="btn-export-confirmed"><i class="fas fa-file-export"></i> Export CSV</button>
                </div>
                <div id="confirmed-list" class="transfers-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing transfer details -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Transfer Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:900;"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where, runTransaction, getDocs, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        (function(){
            const setHeader = (displayName, email) => {
                const name = displayName || email || 'User';
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
                const nameEl = document.getElementById('user-name');
                const roleEl = document.getElementById('user-role');
                if (nameEl) nameEl.textContent = name;
                if (roleEl) roleEl.textContent = 'Authenticated';
            };

            const init = async () => {
                try {
                    const app = initializeApp({ 
                        apiKey: "AIzaSyAqBR_6p-5752sVeu_aMT2sNU2I_nUmaOQ", 
                        authDomain: "inventory-3b638.firebaseapp.com", 
                        projectId: "inventory-3b638", 
                        storageBucket: "inventory-3b638.firebasestorage.app", 
                        messagingSenderId: "65748912542", 
                        appId: "1:65748912542:web:8d40510d194bb3e1d6ae8f", 
                        measurementId: "G-6ECQLDLS71" 
                    });
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            window.location.href = '/login';
                            return;
                        }
                        setHeader(user.displayName, user.email);
                        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.href = '/login');
                        await syncUserAccess(db, user);
                        setupTransfers(db, user);
                    });
                } catch (e) {
                    console.error('Firebase initialization failed:', e);
                    alert('Failed to initialize application. Please try again later.');
                    window.location.href = '/login';
                }
            };

            async function syncUserAccess(db, user) {
                try {
                    const meRef = doc(db, 'users', user.uid);
                    const meSnap = await getDoc(meRef);
                    if (!meSnap.exists()) {
                        await addDoc(collection(db, 'users'), {
                            id: user.uid,
                            role: 'staff', 
                            warehouses: [],
                            name: user.displayName || user.email || 'User',
                            email: user.email,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        });
                    }
                } catch (e) {
                    console.error('syncUserAccess error:', e);
                }
            }

            async function setupTransfers(db, user) {
                const tableBody = document.querySelector('#items-table tbody');
                const draftsList = document.getElementById('drafts-list');
                const confirmedList = document.getElementById('confirmed-list');
                const trfNumber = document.getElementById('trf_number');
                const trfDate = document.getElementById('trf_date');
                const fromWh = document.getElementById('from_wh');
                const toWh = document.getElementById('to_wh');
                const trfNotes = document.getElementById('trf_notes');
                const modal = document.getElementById('transfer-modal');
                const closeModal = document.querySelector('.close-modal');
                const modalBody = document.getElementById('modal-body');
                const modalTitle = document.getElementById('modal-title');
                
                let products = [];
                let warehouses = [];
                let allowedWarehouses = null;

                // Modal handling
                closeModal.onclick = () => {
                    modal.style.display = 'none';
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };

                // Set default date to today
                trfDate.value = new Date().toISOString().split('T')[0];

                // Load user access
                (function loadUserContext(){
                    try {
                        const meRef = doc(db, 'users', user.uid);
                        onSnapshot(meRef, (snap) => {
                            if (snap.exists()) {
                                const u = snap.data();
                                const role = u.role || 'staff';
                                const arr = Array.isArray(u.warehouses) ? u.warehouses.filter(Boolean) : [];
                                allowedWarehouses = (role === 'admin') ? null : arr;
                                loadWarehouses();
                            } else {
                                allowedWarehouses = null;
                                loadWarehouses();
                            }
                        });
                    } catch (e) { console.error('Failed to load user context', e); }
                })();

                // Generate unique transfer number
                async function generateTransferNumber() {
                    const year = new Date().getFullYear();
                    const qy = query(collection(db, 'transfers'), where('number', '>=', `TRF-${year}-`), where('number', '<=', `TRF-${year}-\uf8ff`));
                    const snap = await getDocs(qy);
                    const transfers = snap.docs.map(d => d.data().number).filter(Boolean);
                    const lastNum = transfers
                        .filter(n => n.startsWith(`TRF-${year}-`))
                        .map(n => parseInt(n.split('-')[2] || '0', 10))
                        .sort((a, b) => b - a)[0] || 0;
                    return `TRF-${year}-${String(lastNum + 1).padStart(4, '0')}`;
                }

                // Load products for dropdown
                function loadProducts(warehouse = '') {
                    let qy = query(collection(db, 'products'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        qy = query(qy, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    } else if (warehouse) {
                        qy = query(qy, where('warehouse', '==', warehouse));
                    }
                    onSnapshot(qy, (snap) => {
                        products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Refresh table to update available stock
                        const rows = tableBody.querySelectorAll('tr');
                        rows.forEach(row => {
                            const select = row.querySelector('.product');
                            const selectedId = select.value;
                            const product = products.find(p => p.id === selectedId);
                            row.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                            row.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                        });
                    }, (error) => {
                        console.error('Error loading products:', error);
                        alert('Failed to load products. Please try again.');
                    });
                }

                // Load warehouses into From/To selects
                function loadWarehouses() {
                    let qy = query(collection(db, 'warehouses'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        qy = query(qy, where('name', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(qy, (snap) => {
                        warehouses = snap.docs.map(d => d.data().name).filter(Boolean);
                        const fromSel = fromWh; const toSel = toWh;
                        const currentFrom = fromSel.value; const currentTo = toSel.value;
                        const rebuild = (sel, current) => {
                            sel.innerHTML = '';
                            const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'Select...'; sel.appendChild(opt);
                            warehouses.forEach(w => { const o = document.createElement('option'); o.value = w; o.textContent = w; sel.appendChild(o); });
                            if (warehouses.includes(current)) sel.value = current; else sel.value = '';
                        };
                        rebuild(fromSel, currentFrom);
                        rebuild(toSel, currentTo);
                    }, (error) => {
                        console.error('Error loading warehouses for transfer:', error);
                    });
                }

                // Recalculate summary
                function recalc() {
                    const rows = tableBody.querySelectorAll('tr');
                    let totalQty = 0;
                    rows.forEach(r => {
                        totalQty += Number(r.querySelector('.qty').value || 0);
                    });
                    document.getElementById('sum-rows').textContent = rows.length;
                    document.getElementById('sum-qty').textContent = totalQty;
                }

                // Add table row
                function addRow(data = { productId: '', qty: 1, unit: 'pcs', notes: '' }) {
                    const tr = document.createElement('tr');
                    const product = products.find(p => p.id === data.productId) || {};
                    tr.innerHTML = `
                        <td><select class="product"></select></td>
                        <td class="sku">${product.sku || ''}</td>
                        <td class="available">${product.stock || 0}</td>
                        <td><input type="number" class="qty" min="1" value="${data.qty}"></td>
                        <td><select class="unit"><option value="pcs" ${data.unit === 'pcs' ? 'selected' : ''}>pcs</option><option value="box" ${data.unit === 'box' ? 'selected' : ''}>box</option><option value="kg" ${data.unit === 'kg' ? 'selected' : ''}>kg</option><option value="liter" ${data.unit === 'liter' ? 'selected' : ''}>liter</option></select></td>
                        <td><input type="text" class="row-notes" value="${data.notes}" placeholder="Item notes..."></td>
                        <td><button class="icon-btn btn-remove"><i class="fas fa-trash"></i></button></td>
                    `;
                    const select = tr.querySelector('.product');
                    select.innerHTML = '<option value="">Select Product...</option>';
                    products.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.name || 'Unnamed'} (${p.sku || 'No SKU'})`;
                        if (p.id === data.productId) opt.selected = true;
                        select.appendChild(opt);
                    });
                    tableBody.appendChild(tr);
                    bindRow(tr);
                    recalc();
                }

                // Bind row events
                function bindRow(tr) {
                    const select = tr.querySelector('.product');
                    const qtyInput = tr.querySelector('.qty');
                    select.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        tr.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                        tr.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                        const qty = Number(qtyInput.value || 0);
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity adjusted to available stock.');
                        }
                        recalc();
                    });
                    qtyInput.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        const qty = Number(qtyInput.value || 0);
                        if (qty < 1) {
                            qtyInput.value = 1;
                            alert('Quantity must be at least 1.');
                        }
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity cannot exceed available stock.');
                        }
                        recalc();
                    });
                    qtyInput.addEventListener('input', recalc);
                    tr.querySelector('.btn-remove').addEventListener('click', () => {
                        tr.remove();
                        recalc();
                    });
                }

                // Validate form
                function validateForm() {
                    const from = fromWh.value;
                    const to = toWh.value;
                    if (!from || !to) {
                        alert('Select both source and destination warehouses.');
                        return false;
                    }
                    if (from === to) {
                        alert('Source and destination cannot be the same.');
                        return false;
                    }
                    const rows = tableBody.querySelectorAll('tr');
                    if (rows.length === 0) {
                        alert('Add at least one item.');
                        return false;
                    }
                    for (const row of rows) {
                        const productId = row.querySelector('.product').value;
                        const qty = Number(row.querySelector('.qty').value || 0);
                        if (!productId) {
                            alert('Each row must have a selected product.');
                            return false;
                        }
                        if (qty < 1) {
                            alert('Quantity must be at least 1.');
                            return false;
                        }
                        const product = products.find(p => p.id === productId);
                        if (product && qty > (product.stock || 0)) {
                            alert(`Quantity for ${product.name || 'product'} exceeds available stock.`);
                            return false;
                        }
                        if (product && product.warehouse !== from) {
                            alert(`Product ${product.name || 'product'} is not in the source warehouse (${from}).`);
                            return false;
                        }
                    }
                    return true;
                }

                // Serialize form data
                function serializeTransfer() {
                    const number = trfNumber.value;
                    const date = trfDate.value;
                    const from = fromWh.value;
                    const to = toWh.value;
                    const notes = trfNotes.value;
                    const items = Array.from(tableBody.querySelectorAll('tr')).map(row => {
                        const productId = row.querySelector('.product').value;
                        const product = products.find(p => p.id === productId);
                        return {
                            productId,
                            sku: product ? product.sku || '' : '',
                            name: product ? product.name || '' : '',
                            qty: Number(row.querySelector('.qty').value || 0),
                            unit: row.querySelector('.unit').value,
                            notes: row.querySelector('.row-notes').value
                        };
                    }).filter(item => item.productId && item.qty > 0);
                    if (!from || !to || !items.length) return null;
                    return { number, date, from, to, notes, items };
                }

                // Render drafts and confirmed lists
                function renderLists() {
                    // Render drafts
                    let draftsQ = query(collection(db, 'transfers'), where('status', '==', 'draft'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        draftsQ = query(draftsQ, where('from', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    
                    onSnapshot(draftsQ, (snap) => {
                        const docs = snap.docs
                            .map(d => ({ id: d.id, ...d.data() }))
                            .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        
                        draftsList.innerHTML = '';
                        
                        if (docs.length === 0) {
                            draftsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-file-alt"></i>
                                    <h4>No Draft Transfers</h4>
                                    <p>Create a new transfer above to get started</p>
                                </div>
                            `;
                        } else {
                            docs.forEach(t => {
                                const transferCard = createTransferCard(t, true);
                                draftsList.appendChild(transferCard);
                            });
                        }
                    }, (error) => {
                        console.error('Error loading drafts:', error);
                        draftsList.innerHTML = '<div style="color:#e74c3c; padding:10px;">Failed to load drafts</div>';
                    });

                    // Render confirmed transfers
                    let confirmedQ = query(collection(db, 'transfers'), where('status', '==', 'confirmed'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        confirmedQ = query(confirmedQ, where('from', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    
                    onSnapshot(confirmedQ, (snap) => {
                        const docs = snap.docs
                            .map(d => ({ id: d.id, ...d.data() }))
                            .sort((a, b) => (b.confirmedAt?.seconds || 0) - (a.confirmedAt?.seconds || 0));
                        
                        confirmedList.innerHTML = '';
                        
                        if (docs.length === 0) {
                            confirmedList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <h4>No Confirmed Transfers</h4>
                                    <p>Confirm a draft transfer or submit a new one</p>
                                </div>
                            `;
                        } else {
                            docs.forEach(t => {
                                const transferCard = createTransferCard(t, false);
                                confirmedList.appendChild(transferCard);
                            });
                        }
                    }, (error) => {
                        console.error('Error loading confirmed transfers:', error);
                        confirmedList.innerHTML = '<div style="color:#e74c3c; padding:10px;">Failed to load confirmed transfers</div>';
                    });
                }

                // Create transfer card element
                function createTransferCard(t, isDraft) {
                    const transferCard = document.createElement('div');
                    transferCard.className = 'transfer-card';
                    transferCard.dataset.id = t.id;
                    
                    // Format dates
                    const createdDate = t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : new Date();
                    const createdStr = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const confirmedDate = t.confirmedAt?.seconds ? new Date(t.confirmedAt.seconds * 1000) : null;
                    const confirmedStr = confirmedDate ? confirmedDate.toLocaleDateString() + ' ' + confirmedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    
                    // Header
                    const header = document.createElement('div');
                    header.className = 'transfer-header';
                    header.innerHTML = `
                        <div>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                                <span style="font-weight:600; font-size:16px;">${t.number}</span>
                                <span class="status-badge ${isDraft ? 'status-draft' : 'status-confirmed'}">
                                    ${isDraft ? 'Draft' : 'Confirmed'}
                                </span>
                            </div>
                            <div style="font-size:12px; color:#95a5a6;">
                                <i class="fas fa-warehouse"></i> ${t.from} → ${t.to} • 
                                <i class="fas fa-boxes"></i> ${t.items.length} items • 
                                <i class="fas fa-calendar"></i> ${t.date || createdDate.toLocaleDateString()}
                            </div>
                        </div>
                        <div style="font-size:12px; color:#95a5a6; text-align:right;">
                            ${isDraft ? 'Created: ' + createdStr : 'Confirmed: ' + confirmedStr}
                        </div>
                    `;
                    
                    // Body with items
                    const body = document.createElement('div');
                    body.className = 'transfer-body';
                    
                    if (t.notes) {
                        body.innerHTML += `
                            <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:6px;">
                                <strong>Notes:</strong> ${t.notes}
                            </div>
                        `;
                    }
                    
                    body.innerHTML += '<strong>Items:</strong>';
                    
                    const itemsList = document.createElement('div');
                    itemsList.className = 'items-list';
                    
                    t.items.forEach(item => {
                        const itemCard = document.createElement('div');
                        itemCard.className = 'item-card';
                        itemCard.innerHTML = `
                            <div style="font-weight:500;">${item.name || 'Unnamed Product'}</div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <span style="font-size:12px; color:#666;">SKU: ${item.sku || 'N/A'}</span>
                                <span style="font-weight:600;">${item.qty} ${item.unit}</span>
                            </div>
                            ${item.notes ? `<div style="font-size:11px; color:#888; margin-top:5px;">${item.notes}</div>` : ''}
                        `;
                        itemsList.appendChild(itemCard);
                    });
                    
                    body.appendChild(itemsList);
                    
                    // Footer with actions
                    const footer = document.createElement('div');
                    footer.className = 'transfer-footer';
                    
                    if (isDraft) {
                        footer.innerHTML = `
                            <div style="font-size:12px; color:#666;">
                                <i class="fas fa-user"></i> ${t.createdBy || user.uid}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary btn-small" data-action="view"><i class="fas fa-eye"></i> View</button>
                                <button class="btn btn-success btn-small" data-action="confirm"><i class="fas fa-check"></i> Confirm</button>
                                <button class="btn btn-danger btn-small" data-action="delete"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        `;
                    } else {
                        footer.innerHTML = `
                            <div style="font-size:12px; color:#666;">
                                <i class="fas fa-user-check"></i> ${t.createdBy || user.uid}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary btn-small" data-action="view"><i class="fas fa-eye"></i> View Details</button>
                            </div>
                        `;
                    }
                    
                    // Assemble the card
                    transferCard.appendChild(header);
                    transferCard.appendChild(body);
                    transferCard.appendChild(footer);
                    
                    // Add event listeners
                    const viewBtn = transferCard.querySelector('[data-action="view"]');
                    const confirmBtn = transferCard.querySelector('[data-action="confirm"]');
                    const deleteBtn = transferCard.querySelector('[data-action="delete"]');
                    
                    viewBtn.addEventListener('click', () => viewTransferDetails(t));
                    
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', () => confirmDraft(t.id, t));
                    }
                    
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => deleteDraft(t.id, t.number));
                    }
                    
                    return transferCard;
                }

                // View transfer details in modal
                function viewTransferDetails(t) {
                    modalTitle.textContent = `Transfer: ${t.number}`;
                    
                    const createdDate = t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : new Date();
                    const createdStr = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                    
                    const confirmedDate = t.confirmedAt?.seconds ? new Date(t.confirmedAt.seconds * 1000) : null;
                    const confirmedStr = confirmedDate ? confirmedDate.toLocaleDateString() + ' ' + confirmedDate.toLocaleTimeString() : 'Not confirmed';
                    
                    let itemsHtml = '';
                    t.items.forEach((item, index) => {
                        itemsHtml += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.sku || 'N/A'}</td>
                                <td>${item.name || 'Unnamed Product'}</td>
                                <td>${item.qty}</td>
                                <td>${item.unit}</td>
                                <td>${item.notes || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    modalBody.innerHTML = `
                        <div style="margin-bottom:20px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                                <div>
                                    <strong>From:</strong><br>
                                    ${t.from}
                                </div>
                                <div>
                                    <strong>To:</strong><br>
                                    ${t.to}
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                                <div>
                                    <strong>Transfer Date:</strong><br>
                                    ${t.date || 'N/A'}
                                </div>
                                <div>
                                    <strong>Status:</strong><br>
                                    <span class="status-badge ${t.status === 'draft' ? 'status-draft' : 'status-confirmed'}">
                                        ${t.status}
                                    </span>
                                </div>
                            </div>
                            <div style="margin-bottom:15px;">
                                <strong>Created:</strong> ${createdStr}<br>
                                <strong>Confirmed:</strong> ${confirmedStr}
                            </div>
                            ${t.notes ? `<div style="padding:10px; background:#f8f9fa; border-radius:6px; margin-bottom:15px;">
                                <strong>Notes:</strong><br>${t.notes}
                            </div>` : ''}
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <strong>Items (${t.items.length}):</strong>
                        </div>
                        <div class="table-wrapper">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>SKU</th>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Unit</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        ${t.status === 'draft' ? `
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button id="modal-load-btn" class="btn btn-primary" style="flex:1;">
                                <i class="fas fa-edit"></i> Load into Form
                            </button>
                            <button id="modal-confirm-btn" class="btn btn-success" style="flex:1;">
                                <i class="fas fa-check"></i> Confirm Transfer
                            </button>
                        </div>
                        ` : ''}
                    `;
                    
                    // Add event listeners for modal buttons
                    if (t.status === 'draft') {
                        document.getElementById('modal-load-btn').addEventListener('click', () => {
                            loadIntoForm(t);
                            modal.style.display = 'none';
                        });
                        
                        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                            confirmDraft(t.id, t);
                            modal.style.display = 'none';
                        });
                    }
                    
                    modal.style.display = 'flex';
                }

                // Load transfer into form
                function loadIntoForm(t) {
                    trfNumber.value = t.number;
                    trfDate.value = t.date || new Date().toISOString().split('T')[0];
                    fromWh.value = t.from;
                    toWh.value = t.to;
                    trfNotes.value = t.notes || '';
                    tableBody.innerHTML = '';
                    t.items.forEach(item => addRow({ productId: item.productId, qty: item.qty, unit: item.unit, notes: item.notes }));
                    recalc();
                    alert(`Transfer ${t.number} loaded into form.`);
                }

                // Confirm draft
                async function confirmDraft(id, t) {
                    if (!confirm(`Confirm transfer ${t.number}? This will update stock levels.`)) return;
                    
                    try {
                        // First, validate all products exist and have enough stock
                        const productRefs = t.items.map(item => doc(db, 'products', item.productId));
                        const productDocs = await Promise.all(productRefs.map(ref => getDoc(ref)));
                        
                        // Validate before transaction
                        for (let i = 0; i < t.items.length; i++) {
                            const item = t.items[i];
                            const productDoc = productDocs[i];
                            if (!productDoc.exists()) {
                                throw new Error(`Product ${item.name || item.productId} not found.`);
                            }
                            const product = productDoc.data();
                            if (product.warehouse !== t.from) {
                                throw new Error(`Product ${item.name || item.productId} is not in warehouse ${t.from}.`);
                            }
                            if (item.qty > (product.stock || 0)) {
                                throw new Error(`Insufficient stock for ${item.name || item.productId}. Available: ${product.stock || 0}, Requested: ${item.qty}`);
                            }
                        }
                        
                        // Get destination products in a batch
                        const skus = t.items.map(item => {
                            const productDoc = productDocs.find(doc => doc.id === item.productId);
                            return productDoc?.data()?.sku || '';
                        }).filter(sku => sku);
                        
                        const destProductQueries = skus.map(sku => 
                            query(collection(db, 'products'), where('sku', '==', sku), where('warehouse', '==', t.to))
                        );
                        
                        const destSnapshots = await Promise.all(destProductQueries.map(q => getDocs(q)));
                        
                        // Now execute transaction
                        await runTransaction(db, async (transaction) => {
                            const transferRef = doc(db, 'transfers', id);
                            const transferDoc = await transaction.get(transferRef);
                            
                            if (!transferDoc.exists()) {
                                throw new Error('Transfer not found.');
                            }
                            
                            if (transferDoc.data().status === 'confirmed') {
                                throw new Error('Transfer is already confirmed.');
                            }
                            
                            // Update source products
                            for (let i = 0; i < t.items.length; i++) {
                                const item = t.items[i];
                                const productDoc = productDocs[i];
                                const product = productDoc.data();
                                const newStock = (product.stock || 0) - item.qty;
                                
                                transaction.update(productDoc.ref, {
                                    stock: newStock,
                                    status: newStock === 0 ? 'out-of-stock' : newStock < 20 ? 'low-stock' : 'in-stock',
                                    updatedAt: serverTimestamp(),
                                    updatedBy: user.uid
                                });
                                
                                // Handle destination product
                                const destProducts = destSnapshots[i]?.docs || [];
                                if (destProducts.length > 0) {
                                    // Update existing destination product
                                    const destProduct = destProducts[0];
                                    const destStock = (destProduct.data().stock || 0) + item.qty;
                                    transaction.update(destProduct.ref, {
                                        stock: destStock,
                                        status: destStock < 20 ? 'low-stock' : 'in-stock',
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                } else {
                                    // Create new destination product
                                    const newProductRef = doc(collection(db, 'products'));
                                    transaction.set(newProductRef, {
                                        name: product.name,
                                        sku: product.sku,
                                        category: product.category || 'Uncategorized',
                                        price: product.price || 0,
                                        cost: product.cost || 0,
                                        stock: item.qty,
                                        status: item.qty < 20 ? 'low-stock' : 'in-stock',
                                        warehouse: t.to,
                                        createdAt: serverTimestamp(),
                                        createdBy: user.uid,
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                }
                            }
                            
                            // Update transfer status
                            transaction.update(transferRef, {
                                status: 'confirmed',
                                confirmedAt: serverTimestamp(),
                                updatedAt: serverTimestamp(),
                                updatedBy: user.uid
                            });
                        });
                        
                        alert(`Transfer ${t.number} confirmed successfully.`);
                    } catch (error) {
                        console.error('Error confirming transfer:', error);
                        alert(`Failed to confirm transfer: ${error.message}`);
                    }
                }

                // Delete draft
                async function deleteDraft(id, number) {
                    if (!confirm(`Delete draft ${number}?`)) return;
                    try {
                        await deleteDoc(doc(db, 'transfers', id));
                        alert(`Draft ${number} deleted.`);
                    } catch (error) {
                        console.error('Error deleting draft:', error);
                        alert('Failed to delete draft. Please try again.');
                    }
                }

                // Reset form
                function resetForm() {
                    generateTransferNumber().then(num => trfNumber.value = num);
                    trfDate.value = new Date().toISOString().split('T')[0];
                    fromWh.value = '';
                    toWh.value = '';
                    trfNotes.value = '';
                    tableBody.innerHTML = '';
                    recalc();
                }

                // Save draft
                document.getElementById('btn-save').onclick = async () => {
                    if (!validateForm()) return;
                    const payload = serializeTransfer();
                    if (!payload) return;
                    try {
                        await addDoc(collection(db, 'transfers'), {
                            ...payload,
                            status: 'draft',
                            createdAt: serverTimestamp(),
                            createdBy: user.uid,
                            updatedAt: serverTimestamp(),
                            updatedBy: user.uid
                        });
                        alert('Transfer saved as draft.');
                        resetForm();
                    } catch (error) {
                        console.error('Error saving draft:', error);
                        alert('Failed to save draft. Please try again.');
                    }
                };

                // Submit transfer immediately
                document.getElementById('btn-submit').onclick = async () => {
                    if (!validateForm()) return;
                    const payload = serializeTransfer();
                    if (!payload) return;
                    
                    if (!confirm(`Submit transfer ${payload.number}? This will immediately update stock levels.`)) return;
                    
                    try {
                        // Pre-read all required data
                        const productRefs = payload.items.map(item => doc(db, 'products', item.productId));
                        const productDocs = await Promise.all(productRefs.map(ref => getDoc(ref)));
                        
                        // Validate before transaction
                        for (let i = 0; i < payload.items.length; i++) {
                            const item = payload.items[i];
                            const productDoc = productDocs[i];
                            if (!productDoc.exists()) {
                                throw new Error(`Product ${item.name || item.productId} not found.`);
                            }
                            const product = productDoc.data();
                            if (product.warehouse !== payload.from) {
                                throw new Error(`Product ${item.name || item.productId} is not in warehouse ${payload.from}.`);
                            }
                            if (item.qty > (product.stock || 0)) {
                                throw new Error(`Insufficient stock for ${item.name || item.productId}. Available: ${product.stock || 0}, Requested: ${item.qty}`);
                            }
                        }
                        
                        // Get destination products
                        const skus = payload.items.map(item => {
                            const productDoc = productDocs.find(doc => doc.id === item.productId);
                            return productDoc?.data()?.sku || '';
                        }).filter(sku => sku);
                        
                        const destProductQueries = skus.map(sku => 
                            query(collection(db, 'products'), where('sku', '==', sku), where('warehouse', '==', payload.to))
                        );
                        
                        const destSnapshots = await Promise.all(destProductQueries.map(q => getDocs(q)));
                        
                        // Execute transaction
                        await runTransaction(db, async (transaction) => {
                            const transferRef = doc(collection(db, 'transfers'));
                            
                            // Update source products
                            for (let i = 0; i < payload.items.length; i++) {
                                const item = payload.items[i];
                                const productDoc = productDocs[i];
                                const product = productDoc.data();
                                const newStock = (product.stock || 0) - item.qty;
                                
                                transaction.update(productDoc.ref, {
                                    stock: newStock,
                                    status: newStock === 0 ? 'out-of-stock' : newStock < 20 ? 'low-stock' : 'in-stock',
                                    updatedAt: serverTimestamp(),
                                    updatedBy: user.uid
                                });
                                
                                // Handle destination product
                                const destProducts = destSnapshots[i]?.docs || [];
                                if (destProducts.length > 0) {
                                    const destProduct = destProducts[0];
                                    const destStock = (destProduct.data().stock || 0) + item.qty;
                                    transaction.update(destProduct.ref, {
                                        stock: destStock,
                                        status: destStock < 20 ? 'low-stock' : 'in-stock',
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                } else {
                                    const newProductRef = doc(collection(db, 'products'));
                                    transaction.set(newProductRef, {
                                        name: product.name,
                                        sku: product.sku,
                                        category: product.category || 'Uncategorized',
                                        price: product.price || 0,
                                        cost: product.cost || 0,
                                        stock: item.qty,
                                        status: item.qty < 20 ? 'low-stock' : 'in-stock',
                                        warehouse: payload.to,
                                        createdAt: serverTimestamp(),
                                        createdBy: user.uid,
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                }
                            }
                            
                            // Create transfer record
                            transaction.set(transferRef, {
                                ...payload,
                                status: 'confirmed',
                                createdAt: serverTimestamp(),
                                createdBy: user.uid,
                                updatedAt: serverTimestamp(),
                                updatedBy: user.uid,
                                confirmedAt: serverTimestamp()
                            });
                        });
                        
                        alert('Transfer submitted successfully.');
                        resetForm();
                    } catch (error) {
                        console.error('Error submitting transfer:', error);
                        alert(`Failed to submit transfer: ${error.message}`);
                    }
                };

                // Add row
                document.getElementById('btn-add-row').onclick = () => {
                    if (!products.length) {
                        alert('No products available. Please add products first.');
                        return;
                    }
                    addRow();
                };

                // Export confirmed transfers
                document.getElementById('btn-export-confirmed').onclick = async () => {
                    try {
                        let qy = query(collection(db, 'transfers'), where('status', '==', 'confirmed'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            qy = query(qy, where('from', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        const snap = await getDocs(qy);
                        if (snap.empty) {
                            alert('No confirmed transfers to export.');
                            return;
                        }
                        const headers = ['Transfer Number', 'Date', 'From Warehouse', 'To Warehouse', 'Item Count', 'Items', 'Notes', 'Status', 'Confirmed At'];
                        const rows = snap.docs.map(d => {
                            const t = d.data();
                            const itemsStr = t.items.map(i => `${i.sku || ''} ${i.name} x${i.qty} ${i.unit}`).join(' | ');
                            const confirmedDate = t.confirmedAt?.seconds ? new Date(t.confirmedAt.seconds * 1000).toLocaleString() : '';
                            return [
                                t.number,
                                t.date || '',
                                t.from,
                                t.to,
                                t.items.length,
                                itemsStr,
                                t.notes || '',
                                t.status,
                                confirmedDate
                            ];
                        });
                        const csv = [headers, ...rows].map(row => row.map(cell => {
                            const text = String(cell ?? '').replace(/\s+/g, ' ').trim();
                            return (text.includes(',') || text.includes('"')) ? `"${text.replace(/"/g, '""')}"` : text;
                        }).join(',')).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `confirmed_transfers_${new Date().toISOString().split('T')[0]}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Confirmed transfers exported successfully.');
                    } catch (error) {
                        console.error('Error exporting transfers:', error);
                        alert('Failed to export transfers. Please try again.');
                    }
                };

                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const href = item.dataset.href;
                        if (href) window.location.href = href;
                    });
                });

                // Mobile sidebar toggle
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        sidebar.classList.toggle('mobile-hidden');
                        sidebar.classList.toggle('mobile-visible');
                        overlay.style.display = sidebar.classList.contains('mobile-visible') ? 'block' : 'none';
                    };
                }
                if (overlay) {
                    overlay.onclick = () => {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                        overlay.style.display = 'none';
                    };
                }

                // Search functionality
                document.getElementById('search-bar').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    // Search in drafts
                    const draftCards = draftsList.querySelectorAll('.transfer-card');
                    draftCards.forEach(card => {
                        const text = card.textContent.toLowerCase();
                        card.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                    
                    // Search in confirmed
                    const confirmedCards = confirmedList.querySelectorAll('.transfer-card');
                    confirmedCards.forEach(card => {
                        const text = card.textContent.toLowerCase();
                        card.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                    
                    // Show empty states if all are hidden
                    if (searchTerm) {
                        const visibleDrafts = Array.from(draftCards).filter(c => c.style.display !== 'none').length;
                        const visibleConfirmed = Array.from(confirmedCards).filter(c => c.style.display !== 'none').length;
                        
                        if (visibleDrafts === 0 && draftsList.querySelector('.empty-state')) {
                            draftsList.querySelector('.empty-state').style.display = 'none';
                        }
                        
                        if (visibleConfirmed === 0 && confirmedList.querySelector('.empty-state')) {
                            confirmedList.querySelector('.empty-state').style.display = 'none';
                        }
                    } else {
                        // Restore empty states if they exist
                        const draftEmpty = draftsList.querySelector('.empty-state');
                        if (draftEmpty) draftEmpty.style.display = '';
                        
                        const confirmedEmpty = confirmedList.querySelector('.empty-state');
                        if (confirmedEmpty) confirmedEmpty.style.display = '';
                    }
                });

                // Initialize global warehouse dropdown and sync
                (function initGlobalWarehouse(){
                    const select = document.getElementById('global-warehouse');
                    if (!select) { 
                        generateTransferNumber().then(num => trfNumber.value = num); 
                        loadProducts(); 
                        renderLists(); 
                        return; 
                    }
                    const saved = localStorage.getItem('selectedWarehouse') || '';
                    onSnapshot(query(collection(db, 'warehouses'), orderBy('name')),(snap)=>{
                        const names = snap.docs.map(d => d.data().name).filter(Boolean);
                        select.innerHTML = '';
                        const allOpt = document.createElement('option'); allOpt.value = ''; allOpt.textContent = 'All Warehouses';
                        select.appendChild(allOpt);
                        names.forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; select.appendChild(opt); });
                        select.value = names.includes(saved) ? saved : '';
                        // If a global warehouse is chosen, prefill From and filter products
                        if (select.value) {
                            fromWh.value = select.value;
                            loadProducts(select.value);
                        } else {
                            loadProducts();
                        }
                        generateTransferNumber().then(num => trfNumber.value = num);
                        renderLists();
                    });
                    select.addEventListener('change', () => {
                        localStorage.setItem('selectedWarehouse', select.value);
                        if (select.value) {
                            fromWh.value = select.value;
                            loadProducts(select.value);
                        } else {
                            if (fromWh.value) fromWh.value = '';
                            loadProducts();
                        }
                    });
                })();
            }

            init();
        })();
    </script>
</body>
</html>
