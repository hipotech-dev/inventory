<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - StockMaster</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; overflow-x: hidden; }
        .container { display: flex; min-height: 100vh; width: 100%; max-width: 100%; margin: 0 auto; }
        .sidebar {
            background: var(--primary);
            color: white;
            padding: 20px 0;
            width: 250px;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        .sidebar.mobile-hidden { transform: translateX(-250px); }
        .sidebar.mobile-visible { transform: translateX(0); }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,.1); margin-bottom: 20px; }
        .logo h1 { font-size: 24px; font-weight: 600; }
        .logo span { color: var(--secondary); }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; transition: all .3s; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,.1); border-left: 4px solid var(--secondary); }
        .menu-item i { margin-right: 15px; font-size: 18px; }
        .main-content { flex: 1; padding: 20px; margin-left: 250px; max-width: 100%; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        .search-bar { display: flex; align-items: center; background: #f5f7fa; border-radius: 4px; padding: 8px 15px; width: 300px; }
        .search-bar input { border: none; background: transparent; width: 100%; padding: 5px; outline: none; }
        .user-profile { display: flex; align-items: center; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 600; color: var(--dark); }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all .3s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #27ae60; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c0392b; }
        .orders-table { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: var(--gray); background: #f9f9f9; }
        .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status.paid { background: rgba(46,204,113,.2); color: var(--success); }
        .status.pending { background: rgba(243,156,18,.2); color: var(--warning); }
        .status.cancelled { background: rgba(231,76,60,.2); color: var(--danger); }
        .icon-btn { padding: 6px; border-radius: 4px; cursor: pointer; border: none; color: white; display: inline-flex; align-items: center; justify-content: center; }
        .btn-view { background: var(--success); }
        .btn-edit { background: var(--secondary); }
        .btn-cancel { background: var(--danger); }
        .filters { background: white; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: var(--gray); }
        .filter-group select, .filter-group input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        #order-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid #eee; }
        .modal-body { padding: 16px 18px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; padding: 16px 18px; border-top: 1px solid #eee; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 12px; color: var(--gray); }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        .items-table { margin: 20px 0; }
        .items-table table { width: 100%; border-collapse: collapse; }
        .items-table th, .items-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .items-table th { background: #f9f9f9; }
        .summary { display: flex; gap: 20px; margin-top: 10px; color: var(--gray); }
        @media (max-width: 992px) {
            .container { flex-direction: column; }
            .sidebar { transform: translateX(-250px); }
            .sidebar.mobile-visible { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        @media (max-width: 768px) { 
            .header { flex-direction: column; align-items: flex-start; } 
            .search-bar { width: 100%; margin-bottom: 15px; } 
            .page-header { flex-direction: column; align-items: flex-start; gap: 15px; } 
            .action-buttons { width: 100%; justify-content: space-between; } 
            .btn { flex: 1; justify-content: center; }
            #mobile-menu-btn { display: block !important; }
            .form-row { grid-template-columns: 1fr; }
            .modal-content { width: 95vw; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <select id="global-warehouse" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid rgba(255,255,255,.3); background:#1f2d3a; color:#fff; margin-bottom:8px;"></select>
                <h1>Stock<span>Master</span></h1>
            </div>
            <div class="menu-item" data-href="index.html">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-href="products.html">
                <i class="fas fa-boxes"></i>
                <span>Products</span>
            </div>
            <div class="menu-item" data-href="inventory.html">
                <i class="fas fa-warehouse"></i>
                <span>Inventory</span>
            </div>
            <div class="menu-item active" data-href="orders.html">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Orders</span>
            </div>
            <div class="menu-item" data-href="transfers.html">
                <i class="fas fa-exchange-alt"></i>
                <span>Transfers</span>
            </div>
            <div class="menu-item" data-href="reports.html">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </div>
            <div class="menu-item" data-href="suppliers.html">
                <i class="fas fa-users"></i>
                <span>Suppliers</span>
            </div>
            <div class="menu-item" data-href="settings.html">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" data-href="help.html">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
        <div class="main-content">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%; gap:8px;">
                    <button id="mobile-menu-btn" style="display:none; border:none; background:transparent; font-size:22px; margin-right:10px; cursor:pointer;">☰</button>
                    <div class="search-bar" style="flex:1;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search" placeholder="Search orders...">
                    </div>
                </div>
                <div class="user-profile" id="user-profile">
                    <div style="margin-right:10px;">
                        <div id="user-name">User</div>
                        <small id="user-role">Authenticated</small>
                    </div>
                    <button id="btn-logout" class="btn" style="background:#fff; color:#e74c3c; border:1px solid #e74c3c; padding:8px 10px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
            <div class="page-header">
                <h2 class="page-title">Orders</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-new-order"><i class="fas fa-plus"></i> New Order</button>
                    <button class="btn btn-success" id="btn-export-orders"><i class="fas fa-file-export"></i> Export</button>
                </div>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="">All</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFrom">From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">To</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label for="warehouse">Warehouse</label>
                    <select id="warehouse">
                        <option value="">All</option>
                    </select>
                </div>
            </div>
            <div class="orders-table">
                <table>
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Warehouse</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:900;"></div>

    <!-- New/Edit Order Modal -->
    <div id="order-modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Order</h3>
                <button id="om-close" style="border:none; background:transparent; font-size:18px; cursor:pointer;">✕</button>
            </div>
            <form id="order-form" class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Order #</label>
                        <input type="text" id="of_number" readonly>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="of_date">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Customer</label>
                        <input type="text" id="of_customer" placeholder="Customer name">
                    </div>
                    <div class="form-group">
                        <label>Warehouse</label>
                        <select id="of_warehouse">
                            <option value="">Select...</option>
                        </select>
                    </div>
                </div>
                <div class="items-table">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="font-size:16px;">Items</h4>
                        <button type="button" class="btn btn-primary" id="btn-add-item"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Available</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="summary">
                        <div>Total Items: <span id="sum-items">0</span></div>
                        <div>Total Quantity: <span id="sum-qty">0</span></div>
                        <div>Total Amount: <span id="currency-symbol">$</span><span id="sum-total">0.00</span></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="of_status">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total (<span id="total-currency">$</span>)</label>
                        <input type="number" step="0.01" min="0" id="of_total" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="om-cancel" class="btn" style="background:#fff; color:#3498db; border:1px solid #3498db;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="om-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where, runTransaction, getDoc, setDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        (function(){
            const setHeader = (displayName, email) => {
                const name = displayName || email || 'User';
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
                const nameEl = document.getElementById('user-name');
                const avatarEl = document.getElementById('user-avatar');
                if (nameEl) nameEl.textContent = name;
                if (avatarEl) avatarEl.src = avatar;
            };

            const init = async () => {
                try {
                    const app = initializeApp({ 
                        apiKey: "AIzaSyAqBR_6p-5752sVeu_aMT2sNU2I_nUmaOQ", 
                        authDomain: "inventory-3b638.firebaseapp.com", 
                        projectId: "inventory-3b638", 
                        storageBucket: "inventory-3b638.firebasestorage.app", 
                        messagingSenderId: "65748912542", 
                        appId: "1:65748912542:web:8d40510d194bb3e1d6ae8f", 
                        measurementId: "G-6ECQLDLS71" 
                    });
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            window.location.href = 'login.html';
                            return;
                        }
                        setHeader(user.displayName, user.email);
                        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.href = 'login.html');
                        await syncUserAccess(db, user);
                        const currency = await loadCompanyCurrency(db, user);
                        setupOrders(db, user, currency);
                    });
                } catch (e) {
                    console.error('Firebase initialization failed:', e);
                    alert('Failed to initialize application. Please try again later.');
                    window.location.href = 'login.html';
                }
            };

            async function syncUserAccess(db, user) {
                try {
                    const meRef = doc(db, 'users', user.uid);
                    const meSnap = await getDoc(meRef);
                    if (!meSnap.exists()) {
                        await setDoc(meRef, { 
                            role: 'staff', 
                            warehouses: [],
                            name: user.displayName || user.email || 'User',
                            email: user.email,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error('syncUserAccess error:', e);
                }
            }

            async function loadCompanyCurrency(db, user) {
                try {
                    const ref = doc(db, `users/${user.uid}/settings`, 'profile');
                    const snap = await getDoc(ref);
                    return snap.exists() ? (snap.data().company?.currency || 'USD') : 'USD';
                } catch { return 'USD'; }
            }

            function currencySymbol(code) {
                const map = { USD: '$', EUR: '€', GBP: '£', INR: '₹', TZS: 'TSh', KES: 'KSh', UGX: 'USh' };
                return map[code] || code + ' ';
            }

            async function setupOrders(db, user, currencyCode) {
                const tbody = document.getElementById('orders-body');
                const modal = document.getElementById('order-modal');
                const form = document.getElementById('order-form');
                const itemsTableBody = document.querySelector('#items-table tbody');
                const inputs = {
                    number: document.getElementById('of_number'),
                    date: document.getElementById('of_date'),
                    customer: document.getElementById('of_customer'),
                    warehouse: document.getElementById('of_warehouse'),
                    status: document.getElementById('of_status'),
                    total: document.getElementById('of_total')
                };
                let products = [];
                let warehouses = [];
                let allowedWarehouses = null;
                const urlParams = new URLSearchParams(window.location.search);
                let pendingReorderProductId = urlParams.get('reorderProduct') || null;
                let pendingReorderWarehouse = urlParams.get('reorderWarehouse') || '';

                // Update currency displays
                document.getElementById('currency-symbol').textContent = currencySymbol(currencyCode);
                document.getElementById('total-currency').textContent = currencySymbol(currencyCode);

                // Load user access
                (function loadUserContext(){
                    try {
                        const meRef = doc(db, 'users', user.uid);
                        onSnapshot(meRef, (snap) => {
                            if (snap.exists()) {
                                const u = snap.data();
                                const role = u.role || 'staff';
                                const arr = Array.isArray(u.warehouses) ? u.warehouses.filter(Boolean) : [];
                                allowedWarehouses = (role === 'admin') ? null : arr;
                                loadWarehouses();
                                loadProducts(inputs.warehouse.value);
                                renderOrders();
                            } else {
                                allowedWarehouses = null;
                                loadWarehouses();
                                loadProducts(inputs.warehouse.value);
                                renderOrders();
                            }
                        });
                    } catch (e) { console.error('Failed to load user context', e); }
                })();

                // Generate unique order number
                async function generateOrderNumber() {
                    const year = new Date().getFullYear();
                    const q = query(collection(db, 'orders'), where('number', '>=', `ORD-${year}-`), where('number', '<=', `ORD-${year}-\uf8ff`));
                    const snap = await getDocs(q);
                    const orders = snap.docs.map(d => d.data().number);
                    const lastNum = orders
                        .filter(n => n.startsWith(`ORD-${year}-`))
                        .map(n => parseInt(n.split('-')[2] || '0', 10))
                        .sort((a, b) => b - a)[0] || 0;
                    return `ORD-${year}-${String(lastNum + 1).padStart(4, '0')}`;
                }

                // Load products
                function loadProducts(warehouse = '') {
                    let q = query(collection(db, 'products'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    } else if (warehouse) {
                        q = query(q, where('warehouse', '==', warehouse));
                    }
                    onSnapshot(q, (snap) => {
                        products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        const rows = itemsTableBody.querySelectorAll('tr');
                        rows.forEach(row => {
                            const select = row.querySelector('.product');
                            const selectedId = select.value;
                            select.innerHTML = '<option value="">Select...</option>';
                            products.forEach(p => {
                                const opt = document.createElement('option');
                                opt.value = p.id;
                                opt.textContent = p.name || 'Unnamed';
                                if (p.id === selectedId) opt.selected = true;
                                select.appendChild(opt);
                            });
                            const product = products.find(p => p.id === selectedId);
                            row.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                            row.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                            row.querySelector('.unit-price').value = product ? (product.price || 0).toFixed(2) : '0.00';
                            updateSubtotal(row);
                        });
                        recalc();

                        // If we came from a Reorder action and haven't opened the order yet, prefill it now
                        if (pendingReorderProductId) {
                            const product = products.find(p => p.id === pendingReorderProductId);
                            if (product) {
                                modal.style.display = 'flex';
                                modal.querySelector('h3').textContent = 'New Order';
                                delete form.dataset.id;
                                if (!inputs.number.value) {
                                    generateOrderNumber().then(num => inputs.number.value = num);
                                }
                                if (!inputs.date.value) {
                                    inputs.date.value = new Date().toISOString().split('T')[0];
                                }
                                inputs.customer.value = 'Re-order';
                                if (product.warehouse && !inputs.warehouse.value) {
                                    inputs.warehouse.value = product.warehouse;
                                }
                                itemsTableBody.innerHTML = '';
                                addItem({ productId: product.id, qty: 1, unitPrice: Number(product.price || 0) });
                                recalc();
                                pendingReorderProductId = null;
                            }
                        }
                    }, (error) => {
                        console.error('Error loading products:', error);
                        alert('Failed to load products. Please try again.');
                    });
                }

                // Load warehouses
                function loadWarehouses() {
                    let q = query(collection(db, 'warehouses'), orderBy('name'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        q = query(q, where('name', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    onSnapshot(q, (snap) => {
                        warehouses = snap.docs.map(d => d.data().name).filter(Boolean);
                        const selects = [document.getElementById('warehouse'), inputs.warehouse];
                        selects.forEach(sel => {
                            if (!sel) return;
                            const current = sel.value;
                            sel.innerHTML = '<option value="">All</option>';
                            if (sel.id === 'of_warehouse') sel.innerHTML = '<option value="">Select...</option>';
                            warehouses.forEach(w => {
                                const opt = document.createElement('option');
                                opt.value = w;
                                opt.textContent = w;
                                sel.appendChild(opt);
                            });
                            sel.value = warehouses.includes(current) ? current : '';
                            if (sel === inputs.warehouse && pendingReorderWarehouse && warehouses.includes(pendingReorderWarehouse)) {
                                inputs.warehouse.value = pendingReorderWarehouse;
                            }
                        });
                    }, (error) => {
                        console.error('Error loading warehouses:', error);
                    });
                }

                // Recalculate summary
                function recalc() {
                    const rows = itemsTableBody.querySelectorAll('tr');
                    let totalQty = 0, totalAmount = 0;
                    rows.forEach(row => {
                        const qty = Number(row.querySelector('.qty').value || 0);
                        const price = Number(row.querySelector('.unit-price').value || 0);
                        totalQty += qty;
                        totalAmount += qty * price;
                    });
                    document.getElementById('sum-items').textContent = rows.length;
                    document.getElementById('sum-qty').textContent = totalQty;
                    document.getElementById('sum-total').textContent = totalAmount.toFixed(2);
                    inputs.total.value = totalAmount.toFixed(2);
                }

                // Update subtotal for a row
                function updateSubtotal(row) {
                    const qty = Number(row.querySelector('.qty').value || 0);
                    const price = Number(row.querySelector('.unit-price').value || 0);
                    row.querySelector('.subtotal').textContent = (qty * price).toFixed(2);
                    recalc();
                }

                // Add item row
                function addItem(data = { productId: '', qty: 1, unitPrice: 0 }) {
                    const product = products.find(p => p.id === data.productId) || {};
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><select class="product"><option value="">Select...</option></select></td>
                        <td class="sku">${product.sku || ''}</td>
                        <td class="available">${product.stock || 0}</td>
                        <td><input type="number" class="qty" min="1" value="${data.qty}"></td>
                        <td><input type="number" class="unit-price" step="0.01" min="0" value="${data.unitPrice ? data.unitPrice.toFixed(2) : '0.00'}"></td>
                        <td class="subtotal">${(data.qty * (data.unitPrice || 0)).toFixed(2)}</td>
                        <td><button class="icon-btn btn-remove"><i class="fas fa-trash"></i></button></td>
                    `;
                    const select = tr.querySelector('.product');
                    products.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name || 'Unnamed';
                        if (p.id === data.productId) opt.selected = true;
                        select.appendChild(opt);
                    });
                    itemsTableBody.appendChild(tr);
                    bindItemRow(tr);
                    recalc();
                }

                // Bind item row events
                function bindItemRow(tr) {
                    const select = tr.querySelector('.product');
                    const qtyInput = tr.querySelector('.qty');
                    const priceInput = tr.querySelector('.unit-price');
                    select.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        tr.querySelector('.sku').textContent = product ? (product.sku || '') : '';
                        tr.querySelector('.available').textContent = product ? (product.stock || 0) : 0;
                        priceInput.value = product ? (product.price || 0).toFixed(2) : '0.00';
                        const qty = Number(qtyInput.value || 0);
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity adjusted to available stock.');
                        }
                        updateSubtotal(tr);
                    });
                    qtyInput.addEventListener('change', () => {
                        const product = products.find(p => p.id === select.value);
                        let qty = Number(qtyInput.value || 0);
                        if (qty < 1) {
                            qtyInput.value = 1;
                            qty = 1;
                            alert('Quantity must be at least 1.');
                        }
                        if (product && qty > (product.stock || 0)) {
                            qtyInput.value = product.stock || 0;
                            alert('Quantity cannot exceed available stock.');
                        }
                        updateSubtotal(tr);
                    });
                    priceInput.addEventListener('change', () => {
                        if (Number(priceInput.value) < 0) {
                            priceInput.value = '0.00';
                            alert('Unit price cannot be negative.');
                        }
                        updateSubtotal(tr);
                    });
                    tr.querySelector('.btn-remove').addEventListener('click', () => {
                        tr.remove();
                        recalc();
                    });
                }

                // Validate form
                function validateForm() {
                    if (!inputs.number.value) {
                        alert('Order number is required.');
                        return false;
                    }
                    if (!inputs.customer.value.trim()) {
                        alert('Customer name is required.');
                        return false;
                    }
                    if (!inputs.warehouse.value) {
                        alert('Warehouse is required.');
                        return false;
                    }
                    const rows = itemsTableBody.querySelectorAll('tr');
                    if (rows.length === 0) {
                        alert('Add at least one item.');
                        return false;
                    }
                    for (const row of rows) {
                        const productId = row.querySelector('.product').value;
                        const qty = Number(row.querySelector('.qty').value || 0);
                        const price = Number(row.querySelector('.unit-price').value || 0);
                        if (!productId) {
                            alert('Each row must have a selected product.');
                            return false;
                        }
                        if (qty < 1) {
                            alert('Quantity must be at least 1.');
                            return false;
                        }
                        if (price <= 0) {
                            alert('Unit price must be greater than 0.');
                            return false;
                        }
                        const product = products.find(p => p.id === productId);
                        if (product && qty > (product.stock || 0)) {
                            alert(`Quantity for ${product.name || 'product'} exceeds available stock.`);
                            return false;
                        }
                        if (product && product.warehouse !== inputs.warehouse.value) {
                            alert(`Product ${product.name || 'product'} is not in the selected warehouse.`);
                            return false;
                        }
                    }
                    return true;
                }

                // Serialize form
                function serializeForm() {
                    const rows = itemsTableBody.querySelectorAll('tr');
                    const items = Array.from(rows).map(row => {
                        const productId = row.querySelector('.product').value;
                        const product = products.find(p => p.id === productId);
                        return {
                            productId,
                            sku: product ? product.sku || '' : '',
                            name: product ? product.name || '' : '',
                            qty: Number(row.querySelector('.qty').value || 0),
                            unitPrice: Number(row.querySelector('.unit-price').value || 0),
                            unit: 'pcs'
                        };
                    }).filter(item => item.productId && item.qty > 0 && item.unitPrice > 0);
                    return {
                        number: inputs.number.value,
                        date: inputs.date.value,
                        customer: inputs.customer.value.trim(),
                        warehouse: inputs.warehouse.value,
                        items,
                        total: Number(inputs.total.value || 0),
                        status: inputs.status.value
                    };
                }

                // Load order into form
                function loadOrder(data) {
                    inputs.number.value = data.number;
                    inputs.date.value = data.date || new Date().toISOString().split('T')[0];
                    inputs.customer.value = data.customer || '';
                    inputs.warehouse.value = data.warehouse || '';
                    inputs.status.value = data.status || 'pending';
                    itemsTableBody.innerHTML = '';
                    loadProducts(data.warehouse || '');
                    (data.items || []).forEach(item => addItem({ productId: item.productId, qty: item.qty, unitPrice: item.unitPrice }));
                    recalc();
                }

                // Reset form
                function resetForm() {
                    generateOrderNumber().then(num => inputs.number.value = num);
                    inputs.date.value = new Date().toISOString().split('T')[0];
                    inputs.customer.value = '';
                    inputs.warehouse.value = '';
                    inputs.status.value = 'pending';
                    itemsTableBody.innerHTML = '';
                    inputs.total.value = '0.00';
                    loadProducts();
                    recalc();
                }

                // Render orders
                let unsubscribeOrders;
                function renderOrders() {
                    if (unsubscribeOrders) unsubscribeOrders();
                    let qy = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
                    if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                        qy = query(qy, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                    }
                    unsubscribeOrders = onSnapshot(qy, (snap) => {
                        tbody.innerHTML = snap.empty ? '<tr><td colspan="7" style="text-align:center; color:#95a5a6;">No orders found.</td></tr>' : '';
                        snap.forEach(d => {
                            const o = d.data();
                            const tr = document.createElement('tr');
                            tr.dataset.id = d.id;
                            tr.innerHTML = `
                                <td>${o.number || ''}</td>
                                <td>${o.date || ''}</td>
                                <td>${o.customer || ''}</td>
                                <td>${o.warehouse || ''}</td>
                                <td>${currencySymbol(currencyCode)}${Number(o.total || 0).toFixed(2)}</td>
                                <td><span class="status ${o.status || 'pending'}">${(o.status || 'pending').charAt(0).toUpperCase() + (o.status || 'pending').slice(1)}</span></td>
                                <td>
                                    <button class="icon-btn btn-view" title="View"><i class="fas fa-eye"></i></button>
                                    <button class="icon-btn btn-edit" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="icon-btn btn-cancel" title="Cancel"><i class="fas fa-ban"></i></button>
                                    <button class="icon-btn btn-delete" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            bindRow(tr, d.id, o);
                            tbody.appendChild(tr);
                        });
                        filterOrders();
                    }, (error) => {
                        console.error('Error loading orders:', error);
                        alert('Failed to load orders. Please try again.');
                    });
                }

                // Bind row actions
                function bindRow(tr, id, order) {
                    tr.querySelector('.btn-view').onclick = () => {
                        const itemsList = order.items.map(i => `${i.sku || ''} ${i.name} x${i.qty} @ ${currencySymbol(currencyCode)}${i.unitPrice.toFixed(2)}`).join('\n');
                        alert(`Order ${order.number}\nDate: ${order.date}\nCustomer: ${order.customer}\nWarehouse: ${order.warehouse}\nStatus: ${order.status}\nTotal: ${currencySymbol(currencyCode)}${order.total.toFixed(2)}\nItems:\n${itemsList}`);
                    };
                    tr.querySelector('.btn-edit').onclick = () => {
                        modal.style.display = 'flex';
                        modal.querySelector('h3').textContent = 'Edit Order';
                        form.dataset.id = id;
                        loadOrder(order);
                    };
                    tr.querySelector('.btn-cancel').onclick = async () => {
                        if (!confirm(`Cancel order ${order.number}?`)) return;
                        try {
                            await runTransaction(db, async (transaction) => {
                                const orderRef = doc(db, 'orders', id);
                                const orderDoc = await transaction.get(orderRef);
                                if (!orderDoc.exists()) throw new Error('Order not found.');
                                const orderData = orderDoc.data();
                                if (orderData.status !== 'cancelled') {
                                    for (const item of orderData.items) {
                                        const productRef = doc(db, 'products', item.productId);
                                        const productDoc = await transaction.get(productRef);
                                        if (productDoc.exists()) {
                                            const product = productDoc.data();
                                            transaction.update(productRef, {
                                                stock: (product.stock || 0) + item.qty,
                                                status: ((product.stock || 0) + item.qty) < 20 ? 'low-stock' : 'in-stock',
                                                updatedAt: serverTimestamp(),
                                                updatedBy: user.uid
                                            });
                                        }
                                    }
                                }
                                transaction.update(orderRef, {
                                    status: 'cancelled',
                                    updatedAt: serverTimestamp(),
                                    updatedBy: user.uid
                                });
                            });
                            alert(`Order ${order.number} cancelled.`);
                        } catch (error) {
                            console.error('Error cancelling order:', error);
                            alert('Failed to cancel order. Please try again.');
                        }
                    };
                    tr.querySelector('.btn-delete').onclick = async () => {
                        if (!confirm(`Permanently delete order ${order.number}? This will not change stock.`)) return;
                        try {
                            await deleteDoc(doc(db, 'orders', id));
                            alert(`Order ${order.number} deleted.`);
                        } catch (error) {
                            console.error('Error deleting order:', error);
                            alert('Failed to delete order. Please try again.');
                        }
                    };
                }

                // Form submission
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!validateForm()) return;
                    const data = serializeForm();
                    try {
                        await runTransaction(db, async (transaction) => {
                            const orderRef = form.dataset.id ? doc(db, 'orders', form.dataset.id) : doc(collection(db, 'orders'));
                            // If editing, check previous items to restore stock
                            if (form.dataset.id) {
                                const prevOrder = await transaction.get(orderRef);
                                if (prevOrder.exists() && prevOrder.data().status !== 'cancelled') {
                                    for (const item of prevOrder.data().items) {
                                        const productRef = doc(db, 'products', item.productId);
                                        const product = await transaction.get(productRef);
                                        if (product.exists()) {
                                            transaction.update(productRef, {
                                                stock: (product.data().stock || 0) + item.qty,
                                                status: ((product.data().stock || 0) + item.qty) < 20 ? 'low-stock' : 'in-stock',
                                                updatedAt: serverTimestamp(),
                                                updatedBy: user.uid
                                            });
                                        }
                                    }
                                }
                            }
                            // Update stock for new items if not cancelled
                            if (data.status !== 'cancelled') {
                                for (const item of data.items) {
                                    const productRef = doc(db, 'products', item.productId);
                                    const product = await transaction.get(productRef);
                                    if (!product.exists()) throw new Error(`Product ${item.name} not found.`);
                                    if (product.data().warehouse !== data.warehouse) throw new Error(`Product ${item.name} is not in warehouse ${data.warehouse}.`);
                                    if (item.qty > (product.data().stock || 0)) throw new Error(`Insufficient stock for ${item.name}.`);
                                    transaction.update(productRef, {
                                        stock: (product.data().stock || 0) - item.qty,
                                        status: ((product.data().stock || 0) - item.qty) === 0 ? 'out-of-stock' : ((product.data().stock || 0) - item.qty) < 20 ? 'low-stock' : 'in-stock',
                                        updatedAt: serverTimestamp(),
                                        updatedBy: user.uid
                                    });
                                }
                            }
                            // Save order
                            const orderData = {
                                number: data.number,
                                date: data.date,
                                customer: data.customer,
                                warehouse: data.warehouse,
                                items: data.items,
                                total: data.total,
                                status: data.status,
                                updatedAt: serverTimestamp(),
                                updatedBy: user.uid
                            };
                            if (!form.dataset.id) {
                                orderData.createdAt = serverTimestamp();
                                orderData.createdBy = user.uid;
                            }
                            transaction.set(orderRef, orderData);
                        });
                        alert(form.dataset.id ? 'Order updated successfully.' : 'Order created successfully.');
                        modal.style.display = 'none';
                        resetForm();
                    } catch (error) {
                        console.error('Error saving order:', error);
                        alert(`Failed to save order: ${error.message}`);
                    }
                };

                // Modal controls
                document.getElementById('btn-new-order').onclick = () => {
                    modal.style.display = 'flex';
                    modal.querySelector('h3').textContent = 'New Order';
                    delete form.dataset.id;
                    resetForm();
                };
                document.getElementById('om-close').onclick = () => {
                    modal.style.display = 'none';
                    resetForm();
                };
                document.getElementById('om-cancel').onclick = () => {
                    modal.style.display = 'none';
                    resetForm();
                };
                document.getElementById('btn-add-item').onclick = () => {
                    if (!products.length) {
                        alert('No products available for selected warehouse. Please select a warehouse or add products.');
                        return;
                    }
                    addItem();
                };

                // Warehouse change updates products
                inputs.warehouse.onchange = () => {
                    itemsTableBody.innerHTML = '';
                    loadProducts(inputs.warehouse.value);
                    recalc();
                };

                // Export orders
                document.getElementById('btn-export-orders').onclick = async () => {
                    try {
                        let q = query(collection(db, 'orders'));
                        if (Array.isArray(allowedWarehouses) && allowedWarehouses.length > 0) {
                            q = query(q, where('warehouse', 'in', allowedWarehouses.slice(0, 10)));
                        }
                        const snap = await getDocs(q);
                        if (snap.empty) {
                            alert('No orders to export.');
                            return;
                        }
                        const headers = ['Order #', 'Date', 'Customer', 'Warehouse', 'Items', 'Total', 'Status'];
                        const rows = snap.docs.map(d => {
                            const o = d.data();
                            const itemsStr = o.items.map(i => `${i.sku || ''} ${i.name} x${i.qty} @ ${currencySymbol(currencyCode)}${i.unitPrice.toFixed(2)}`).join(' | ');
                            return [o.number, o.date || '', o.customer, o.warehouse, itemsStr, o.total.toFixed(2), o.status];
                        });
                        const csv = [headers, ...rows].map(row => row.map(cell => {
                            const text = String(cell ?? '').replace(/\s+/g, ' ').trim();
                            return (text.includes(',') || text.includes('"')) ? `"${text.replace(/"/g, '""')}"` : text;
                        }).join(',')).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Orders exported successfully.');
                    } catch (error) {
                        console.error('Error exporting orders:', error);
                        alert('Failed to export orders. Please try again.');
                    }
                };

                // Filter orders
                function filterOrders() {
                    const statusVal = document.getElementById('status').value;
                    const fromVal = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
                    const toVal = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;
                    const warehouseVal = document.getElementById('warehouse').value;
                    const searchVal = (document.getElementById('search').value || '').toLowerCase();
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        if (!row || row.children.length < 7) { return; }
                        const numberCell = row.children[0];
                        const dateCell = row.children[1];
                        const customerCell = row.children[2];
                        const warehouseCell = row.children[3];
                        const statusEl = row.querySelector('.status');
                        if (!numberCell || !dateCell || !customerCell || !warehouseCell || !statusEl) { return; }
                        const number = (numberCell.textContent || '').toLowerCase();
                        const date = new Date(dateCell.textContent || '');
                        const customer = (customerCell.textContent || '').toLowerCase();
                        const warehouse = warehouseCell.textContent || '';
                        const status = statusEl.classList[1] || '';
                        let visible = true;
                        if (statusVal && status !== statusVal) visible = false;
                        if (fromVal && (isFinite(date) ? date < fromVal : false)) visible = false;
                        if (toVal && (isFinite(date) ? date > toVal : false)) visible = false;
                        if (warehouseVal && warehouse !== warehouseVal) visible = false;
                        if (searchVal && !(number.includes(searchVal) || customer.includes(searchVal))) visible = false;
                        row.style.display = visible ? '' : 'none';
                    });
                }

                // Bind filter events
                [document.getElementById('status'), document.getElementById('dateFrom'), document.getElementById('dateTo'), document.getElementById('warehouse')].forEach(el => el.addEventListener('change', filterOrders));
                document.getElementById('search').addEventListener('input', filterOrders);

                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const href = item.dataset.href;
                        if (href) window.location.href = href;
                    });
                });

                // Mobile sidebar toggle
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuBtn = document.getElementById('mobile-menu-btn');
                if (menuBtn) {
                    menuBtn.onclick = () => {
                        sidebar.classList.toggle('mobile-hidden');
                        sidebar.classList.toggle('mobile-visible');
                        overlay.style.display = sidebar.classList.contains('mobile-visible') ? 'block' : 'none';
                    };
                }
                if (overlay) {
                    overlay.onclick = () => {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                        overlay.style.display = 'none';
                    };
                }

                // Initialize global warehouse dropdown
                (function initGlobalWarehouse(){
                    const select = document.getElementById('global-warehouse');
                    if (!select) { 
                        loadWarehouses();
                        renderOrders();
                        generateOrderNumber().then(num => inputs.number.value = num);
                        return; 
                    }
                    const saved = localStorage.getItem('selectedWarehouse') || '';
                    onSnapshot(query(collection(db, 'warehouses'), orderBy('name')), (snap) => {
                        const names = snap.docs.map(d => d.data().name).filter(Boolean);
                        select.innerHTML = '';
                        const allOpt = document.createElement('option');
                        allOpt.value = '';
                        allOpt.textContent = 'All Warehouses';
                        select.appendChild(allOpt);
                        names.forEach(n => {
                            const opt = document.createElement('option');
                            opt.value = n;
                            opt.textContent = n;
                            select.appendChild(opt);
                        });
                        select.value = names.includes(saved) ? saved : '';
                        const pageFilter = document.getElementById('warehouse');
                        if (pageFilter) pageFilter.value = select.value;
                        loadProducts(select.value);
                        renderOrders();
                        generateOrderNumber().then(num => inputs.number.value = num);
                    });
                    select.addEventListener('change', () => {
                        localStorage.setItem('selectedWarehouse', select.value);
                        const pageFilter = document.getElementById('warehouse');
                        if (pageFilter && pageFilter.value !== select.value) pageFilter.value = select.value;
                        itemsTableBody.innerHTML = '';
                        loadProducts(select.value);
                        renderOrders();
                    });
                })();
            }

            init();
        })();
    </script>
</body>
</html>